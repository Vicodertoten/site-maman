---
import MainLayout from '../../layouts/MainLayout.astro';
import type { RecipeData } from '../../lib/sanity';

export async function getStaticPaths() {
  const { getRecipesData } = await import('../../lib/sanity');
  const recipes = await getRecipesData();

  return recipes.map((recipe) => ({
    params: {
      slug: recipe.slug?.current || recipe._id
    },
    props: {
      recipe
    }
  }));
}

const { recipe } = Astro.props as { recipe: RecipeData };

// Si la recette n'existe pas, afficher une page 404
if (!recipe) {
  return Astro.redirect('/404');
}

// Fonction pour obtenir le nom de la catégorie
function getCategoryName(category: string): string {
  const categories: { [key: string]: string } = {
    'entree': 'Entrée',
    'plat': 'Plat principal',
    'dessert': 'Dessert',
    'boisson': 'Boisson',
    'accompagnement': 'Accompagnement'
  };
  return categories[category] || category;
}

// Fonction pour obtenir la couleur de difficulté
function getDifficultyColor(difficulty: string): string {
  switch (difficulty) {
    case 'facile': return 'bg-mv-leaf/20 text-mv-leaf';
    case 'moyen': return 'bg-mv-amber/20 text-mv-amber';
    case 'difficile': return 'bg-mv-red/20 text-mv-red';
    default: return 'bg-mv-cream text-mv-forest';
  }
}
---

<MainLayout title={`${recipe.title} - Recettes | Gastronomade`}>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Header -->
    <header class="text-center mb-12">
      {recipe.featuredImage && (
        <div class="mb-8">
          <img
            src={`${recipe.featuredImage}?w=800&h=400&fit=crop&auto=format`}
            alt={recipe.title}
            class="w-full max-w-2xl mx-auto rounded-lg shadow-lg"
          />
        </div>
      )}

      <div class="flex items-center justify-center gap-4 mb-4">
        <span class="text-sm font-medium text-vert-foret bg-vert-foret/10 px-3 py-1 rounded-full">
          {getCategoryName(recipe.category)}
        </span>
        {recipe.difficulty && (
          <span class={`text-sm font-medium px-3 py-1 rounded-full ${getDifficultyColor(recipe.difficulty)}`}>
            {recipe.difficulty.charAt(0).toUpperCase() + recipe.difficulty.slice(1)}
          </span>
        )}
      </div>

      <h1 class="text-4xl md:text-5xl font-serif font-bold text-vert-foret mb-4">
        {recipe.title}
      </h1>

      <p class="text-xl text-gray-600 max-w-2xl mx-auto mb-8">
        {recipe.description}
      </p>

      <!-- Recipe Meta -->
      <div class="flex items-center justify-center gap-8 text-gray-600">
        {recipe.prepTime && (
          <div class="text-center">
            <div class="text-2xl font-bold text-vert-foret">{recipe.prepTime}min</div>
            <div class="text-sm">Préparation</div>
          </div>
        )}
        {recipe.cookTime && recipe.cookTime > 0 && (
          <div class="text-center">
            <div class="text-2xl font-bold text-vert-foret">{recipe.cookTime}min</div>
            <div class="text-sm">Cuisson</div>
          </div>
        )}
        {recipe.servings && (
          <div class="text-center">
            <div class="text-2xl font-bold text-vert-foret">{recipe.servings}</div>
            <div class="text-sm">Personnes</div>
          </div>
        )}
      </div>
    </header>

    <div class="grid md:grid-cols-3 gap-8">
      <!-- Ingredients -->
      <div class="md:col-span-1">
        <div class="bg-beige-creme rounded-lg p-6 sticky top-8">
          <h2 class="text-2xl font-serif font-bold text-vert-foret mb-6">
            Ingrédients
          </h2>
          {recipe.ingredients && recipe.ingredients.length > 0 ? (
            <ul class="space-y-3">
              {recipe.ingredients.map((ingredient, index) => (
                <li key={index} class="flex items-start">
                  <span class="inline-block w-2 h-2 bg-vert-foret rounded-full mt-2 mr-3 flex-shrink-0"></span>
                  <span class="text-gray-700">
                    <span class="font-medium">{ingredient.name}</span>
                    {ingredient.quantity && (
                      <span class="text-gray-600 ml-2">
                        - {ingredient.quantity} {ingredient.unit}
                      </span>
                    )}
                  </span>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-gray-600">Ingrédients à venir...</p>
          )}
        </div>
      </div>

      <!-- Instructions -->
      <div class="md:col-span-2">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-serif font-bold text-vert-foret mb-6">
            Instructions
          </h2>
          {recipe.instructions && recipe.instructions.length > 0 ? (
            <div class="space-y-6">
              {recipe.instructions.map((block, index) => (
                <div key={index} class="flex">
                  <span class="flex-shrink-0 w-8 h-8 bg-vert-foret text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">
                    {index + 1}
                  </span>
                  <div class="text-gray-700 leading-relaxed">
                    {block.children?.map((child, childIndex) => (
                      <span key={childIndex}>{child.text}</span>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-600">Instructions à venir...</p>
          )}
        </div>

        <!-- Tags -->
        {recipe.tags && recipe.tags.length > 0 && (
          <div class="mt-8">
            <h3 class="text-lg font-semibold text-vert-foret mb-4">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {recipe.tags.map((tag, index) => (
                <span key={index} class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Navigation -->
    <nav class="mt-16 text-center">
      <a
        href="/recettes"
        class="inline-flex items-center px-6 py-3 bg-vert-foret text-white rounded-lg font-medium hover:bg-vert-foret-doux transition-colors"
      >
        ← Retour aux recettes
      </a>
    </nav>
  </article>
</MainLayout>