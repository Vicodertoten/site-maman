---
import MainLayout from '../../layouts/MainLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import ShoppingList from '../../components/ShoppingList.astro';
import FavoritesManager from '../../components/FavoritesManager.astro';
import Section from '../../components/Section.astro';
import { getRecipeBySlug, getRecipesData } from '../../lib/sanity';
import { renderPortableText } from '../../lib/portableText';
import { getEntitledPackIds, getSessionEmail, getSessionTokenFromRequest } from '../../lib/server/access';

export const prerender = false;

function toAsciiSlug(value: string): string {
  return (value || '')
    .toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/['’]/g, '-')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/-{2,}/g, '-')
    .replace(/^-+|-+$/g, '')
    .slice(0, 72)
    .replace(/-+$/g, '');
}

const slug = Astro.params.slug;
const normalizedSlug = slug ? toAsciiSlug(slug) : '';
let recipe = slug ? await getRecipeBySlug(slug) : null;
if (!recipe && slug && normalizedSlug && normalizedSlug !== slug) {
  recipe = await getRecipeBySlug(normalizedSlug);
  if (recipe) {
    return Astro.redirect(`/recette/${encodeURIComponent(normalizedSlug)}/`, 301);
  }
}

let isNotFound = !recipe;
const packIds = recipe?.packIds || [];
if (!isNotFound && packIds.length > 0) {
  const sessionToken = getSessionTokenFromRequest(Astro.request);
  if (!sessionToken) {
    isNotFound = true;
  } else {
    const email = await getSessionEmail(sessionToken);
    if (!email) {
      isNotFound = true;
    } else {
      const entitledPackIds = await getEntitledPackIds(email);
      const hasAccess = packIds.some((packId) => entitledPackIds.includes(packId));
      if (!hasAccess) {
        isNotFound = true;
      }
    }
  }
}

if (isNotFound) {
  Astro.response.status = 404;
}

const recipesForRelated = !isNotFound ? await getRecipesData() : [];

// Fonction pour obtenir le nom de la catégorie
function getCategoryName(category: string): string {
  const categories: { [key: string]: string } = {
    'entree': 'Entrée',
    'plat': 'Plat principal',
    'dessert': 'Dessert',
    'boisson': 'Boisson',
    'accompagnement': 'Accompagnement'
  };
  return categories[category] || category;
}

function getDifficultyColor(difficulty: string): string {
  switch (difficulty) {
    case 'facile': return 'bg-mv-leaf-30 text-mv-leaf border border-mv-leaf-50';
    case 'moyen': return 'bg-mv-coral-30 text-mv-coral border border-mv-coral-50';
    case 'difficile': return 'bg-mv-coral-50 text-mv-coral border border-mv-coral-50';
    default: return 'bg-mv-cream text-mv-forest border border-mv-leaf';
  }
}

function formatTime(minutes?: number): string {
  if (!minutes || minutes <= 0) return '';
  const rounded = Math.round(minutes);
  if (rounded < 60) {
    return `${rounded} min`;
  }
  const hours = Math.floor(rounded / 60);
  const mins = rounded % 60;
  return mins > 0 ? `${hours}h ${mins.toString().padStart(2, '0')} min` : `${hours}h`;
}

function normalizeText(value: string): string {
  return value.replace(/\s+/g, ' ').trim();
}

function normalizeSearchValue(value?: string | null): string {
  return (value ?? '')
    .toString()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function buildRecipeDescription(recipeData: any): string {
  const explicitDescription = (recipeData?.description || '').trim();
  if (explicitDescription) return explicitDescription;

  const subtitle = (recipeData?.subtitle || '').trim();
  if (subtitle) return subtitle;

  const categoryLabel = getCategoryName(recipeData?.category || 'recette');
  return `Recette ${categoryLabel.toLowerCase()} : ${recipeData?.title || 'Gastronomade'}.`;
}

function toValidDate(value?: string | null): Date | null {
  if (!value) return null;
  const date = new Date(value);
  return Number.isNaN(date.getTime()) ? null : date;
}

function portableTextToPlainText(blocks?: any[]): string[] {
  if (!Array.isArray(blocks)) return [];
  return blocks
    .map((block) => {
      if (!block) return '';
      if (typeof block === 'string') return block;
      if (Array.isArray(block.children)) {
        return block.children.map((child) => child?.text || '').join(' ');
      }
      if (typeof block.text === 'string') return block.text;
      return '';
    })
    .map((text) => normalizeText(text))
    .filter(Boolean);
}

const totalTime = (recipe?.prepTime || 0) + (recipe?.cookTime || 0) + (recipe?.restTime || 0);
const recipeSummary = buildRecipeDescription(recipe);
const visibleDescription = (recipe?.description || '').trim() || (!(recipe?.subtitle || '').trim() ? recipeSummary : '');
const pageDescription = recipeSummary.trim();
const pageImage = recipe?.featuredImageUrl
  ? `${recipe.featuredImageUrl}?w=1200&h=630&fit=crop&auto=format`
  : undefined;
const publishedDate = toValidDate(recipe?.publishedAt);
const modifiedDate = toValidDate(recipe?._updatedAt || recipe?.publishedAt);
const hasUpdatedDate = Boolean(
  publishedDate &&
  modifiedDate &&
  modifiedDate.getTime() - publishedDate.getTime() > 60 * 60 * 1000
);
const dateFormatter = new Intl.DateTimeFormat('fr-BE', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
});
const publishedDateLabel = publishedDate ? dateFormatter.format(publishedDate) : null;
const updatedDateLabel = hasUpdatedDate && modifiedDate ? dateFormatter.format(modifiedDate) : null;

const budgetLabels: { [key: string]: string } = {
  'economique': 'Économique',
  'intermediaire': 'Intermédiaire',
  'genereux': 'Généreux'
};

const dietLabels: { [key: string]: string } = {
  'vegetarien': 'Végétarien',
  'vegan': 'Vegan',
  'pescetarien': 'Pescétarien',
  'sans-gluten': 'Sans gluten',
  'sans-lactose': 'Sans lactose',
  'sans-sucre': 'Sans sucre raffiné',
  'ig-bas': 'IG bas'
};

const seasonLabels: { [key: string]: string } = {
  'printemps': 'Printemps',
  'ete': 'Été',
  'automne': 'Automne',
  'hiver': 'Hiver'
};

const ingredientsWithIndex = (recipe?.ingredients || []).map((ingredient, index) => ({
  ...ingredient,
  _index: index
}));

const ingredientGroups = ingredientsWithIndex.reduce((groups: Record<string, typeof ingredientsWithIndex>, ingredient) => {
  const key = ingredient.group?.trim() || '';
  if (!groups[key]) groups[key] = [];
  groups[key].push(ingredient);
  return groups;
}, {} as Record<string, typeof ingredientsWithIndex>);

const galleryImages = (recipe?.gallery || []).filter((image) => image?.url);
const hasInstructionLists = (recipe?.instructions || []).some((block) => block?.listItem);

const breadcrumbs = [
  { label: 'Accueil', href: '/' },
  { label: 'Recettes', href: '/recettes' },
  { label: recipe?.title || 'Recette', current: true }
];

const instructionSteps = portableTextToPlainText(recipe?.instructions);
const recipeIngredients = (recipe?.ingredients || [])
  .map((ingredient) => [ingredient?.quantity, ingredient?.unit, ingredient?.name].filter(Boolean).join(' '))
  .map((text) => normalizeText(text))
  .filter(Boolean);

const relatedRecipes = (!isNotFound && recipe)
  ? (() => {
      const allRecipes = recipesForRelated;
      const currentCategory = normalizeSearchValue(recipe.category);
      const currentTags = new Set((recipe.tags || []).map((tag) => normalizeSearchValue(tag)).filter(Boolean));

      return allRecipes
        .map((candidate) => {
          if (!candidate?.slug?.current || candidate._id === recipe._id) return null;

          const candidateCategory = normalizeSearchValue(candidate.category);
          const candidateTags = (candidate.tags || [])
            .map((tag) => normalizeSearchValue(tag))
            .filter(Boolean);
          const sharedTags = candidateTags.filter((tag) => currentTags.has(tag));
          const sameCategory = currentCategory && candidateCategory === currentCategory;

          let score = 0;
          if (sameCategory) score += 3;
          score += Math.min(sharedTags.length, 3);
          if (candidate.isPopular) score += 0.5;
          if (candidate.isNew) score += 0.25;

          if (score <= 0) return null;

          const relationLabel = sameCategory
            ? 'Même catégorie'
            : sharedTags.length > 0
              ? `Tag commun: ${sharedTags[0]}`
              : 'Recette proche';

          return {
            id: candidate._id,
            title: candidate.title,
            slug: candidate.slug.current,
            category: getCategoryName(candidate.category),
            image: candidate.featuredImageUrl
              ? `${candidate.featuredImageUrl}?w=480&h=320&fit=crop&auto=format`
              : '',
            imageAlt: (candidate.featuredImageAlt || '').trim() || `Photo de ${candidate.title}`,
            relationLabel,
            score,
            publishedAt: candidate.publishedAt
          };
        })
        .filter((item): item is NonNullable<typeof item> => Boolean(item))
        .sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          return new Date(b.publishedAt || 0).getTime() - new Date(a.publishedAt || 0).getTime();
        })
        .slice(0, 4);
    })()
  : [];

const keywordSet = new Set<string>();
if (recipe?.category) keywordSet.add(recipe.category);
if (recipe?.difficulty) keywordSet.add(recipe.difficulty);
(recipe?.tags || []).forEach((tag) => keywordSet.add(tag));
(recipe?.diet || []).forEach((diet) => keywordSet.add(diet));
(recipe?.season || []).forEach((season) => keywordSet.add(season));

const keywords = keywordSet.size > 0 ? Array.from(keywordSet).join(', ') : undefined;
const nutrition = recipe?.nutrition || {};
const hasNutrition = Object.values(nutrition).some((value) => typeof value === 'number');
const hasPracticalInfo = Boolean(
  (recipe?.equipment && recipe.equipment.length > 0)
  || (recipe?.allergens && recipe.allergens.length > 0)
  || (recipe?.storage && recipe.storage.trim().length > 0)
);
const nutritionJsonLd = hasNutrition
  ? {
      "@type": "NutritionInformation",
      "calories": typeof nutrition.calories === 'number' ? `${nutrition.calories} kcal` : undefined,
      "proteinContent": typeof nutrition.protein === 'number' ? `${nutrition.protein} g` : undefined,
      "carbohydrateContent": typeof nutrition.carbs === 'number' ? `${nutrition.carbs} g` : undefined,
      "fatContent": typeof nutrition.fat === 'number' ? `${nutrition.fat} g` : undefined,
      "fiberContent": typeof nutrition.fiber === 'number' ? `${nutrition.fiber} g` : undefined
    }
  : undefined;

const pageUrl = new URL(Astro.url.pathname, Astro.url.origin).toString();

const breadcrumbJsonLd = (!isNotFound && recipe) ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.label,
    "item": item.href ? new URL(item.href, Astro.url.origin).toString() : pageUrl
  }))
} : null;

const jsonLd = [breadcrumbJsonLd].filter(Boolean);
---

<MainLayout
  title={recipe.title}
  description={pageDescription}
  image={pageImage}
  jsonLd={jsonLd}
  articleDate={recipe.publishedAt}
  seo={{ type: 'Recipe', data: recipe }}
>
  {isNotFound ? (
    <Section class="bg-white" containerClass="max-w-xl text-center">
      <h1 class="text-3xl font-serif font-bold text-mv-forest mb-4" slot="content">Recette introuvable</h1>
      <p class="text-mv-forest-70" slot="content">
        Cette recette n'est pas disponible ou l'accès n'est pas autorisé.
      </p>
      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center" slot="content">
        <a href="/recettes" class="mv-btn mv-btn-primary">Retour aux recettes</a>
        <a href="/" class="mv-btn mv-btn-secondary">Retour à l'accueil</a>
      </div>
    </Section>
  ) : (
    <>
      <FavoritesManager />
      <ShoppingList />

      <article class="mv-container max-w-6xl pb-12 sm:pb-16 lg:pb-20">
        <Breadcrumbs items={breadcrumbs} />

    <header class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-10 mb-10">
      <div class="lg:col-span-7">
        {recipe.featuredImageUrl && (
          <div class="overflow-hidden rounded-2xl shadow-lg">
            <img
              src={`${recipe.featuredImageUrl}?w=1000&h=700&fit=crop&auto=format`}
              alt={recipe.featuredImageAlt || `Photo de ${recipe.title}`}
              class="w-full h-full object-cover"
              loading="eager"
              fetchpriority="high"
              decoding="async"
              width="1000"
              height="700"
              sizes="(min-width: 1024px) 60vw, 100vw"
            />
          </div>
        )}

        {galleryImages.length > 0 && (
          <div class="grid grid-cols-3 sm:grid-cols-4 gap-2 mt-4">
            {galleryImages.map((image, index) => (
              <div class="overflow-hidden rounded-lg border border-mv-leaf-20" key={index}>
                <img
                  src={`${image.url}?w=300&h=240&fit=crop&auto=format`}
                  alt={image.alt || `Aperçu ${recipe.title} ${index + 1}`}
                  class="w-full h-full object-cover"
                  loading="lazy"
                  decoding="async"
                  width="300"
                  height="240"
                  sizes="(min-width: 1024px) 12vw, (min-width: 640px) 20vw, 33vw"
                />
              </div>
            ))}
          </div>
        )}
      </div>

      <div class="lg:col-span-5">
        <div class="flex flex-wrap items-center gap-2 mb-4">
          <span class="mv-chip">
            {getCategoryName(recipe.category)}
          </span>
          {recipe.difficulty && (
            <span class={`text-xs sm:text-sm font-medium px-3 py-1 rounded-full ${getDifficultyColor(recipe.difficulty)}`}>
              {recipe.difficulty.charAt(0).toUpperCase() + recipe.difficulty.slice(1)}
            </span>
          )}
        </div>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-serif font-bold text-mv-forest mb-3 leading-tight">
          {recipe.title}
        </h1>

        {recipe.subtitle && (
          <p class="text-base sm:text-lg text-mv-forest-70 font-medium mb-3">
            {recipe.subtitle}
          </p>
        )}

        {(publishedDateLabel || updatedDateLabel) && (
          <div class="text-sm text-mv-forest-60 mb-4 space-y-1">
            {publishedDateLabel && publishedDate && (
              <p>
                Publié le <time datetime={publishedDate.toISOString()}>{publishedDateLabel}</time>
              </p>
            )}
            {updatedDateLabel && modifiedDate && (
              <p>
                Mis à jour le <time datetime={modifiedDate.toISOString()}>{updatedDateLabel}</time>
              </p>
            )}
          </div>
        )}

        {visibleDescription && (
          <p class="text-base sm:text-lg text-mv-forest-70 mb-6 leading-relaxed">
            {visibleDescription}
          </p>
        )}

        <div class="flex flex-wrap gap-3 mb-6">
          <button
            class="favorite-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-mv-leaf text-mv-cream hover:bg-mv-forest hover:text-mv-cream transition-colors"
            data-recipe-id={recipe._id}
            data-recipe-title={recipe.title}
            aria-label="Ajouter aux favoris"
          >
            <svg class="favorite-icon w-4 h-4 text-mv-cream" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <span class="text-sm font-medium">Favori</span>
          </button>

          <button
            id="add-all-ingredients"
            class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <span class="text-sm font-medium">Ajouter à la liste</span>
          </button>

          <button
            id="copy-recipe-link"
            class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 8a3 3 0 00-3-3H6a3 3 0 00-3 3v6a3 3 0 003 3h6a3 3 0 003-3m0-6h2a3 3 0 013 3v6a3 3 0 01-3 3h-6a3 3 0 01-3-3"/>
            </svg>
            <span class="text-sm font-medium">Copier le lien</span>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          {recipe.prepTime && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Préparation</p>
              <p class="text-base font-semibold text-mv-forest">{formatTime(recipe.prepTime)}</p>
            </div>
          )}
          {recipe.cookTime && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Cuisson</p>
              <p class="text-base font-semibold text-mv-forest">{formatTime(recipe.cookTime)}</p>
            </div>
          )}
          {recipe.restTime && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Repos</p>
              <p class="text-base font-semibold text-mv-forest">{formatTime(recipe.restTime)}</p>
            </div>
          )}
          {totalTime > 0 && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Total</p>
              <p class="text-base font-semibold text-mv-forest">{formatTime(totalTime)}</p>
            </div>
          )}
          {recipe.servings && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Portions</p>
              <p class="text-base font-semibold text-mv-forest">{recipe.servings} pers.</p>
            </div>
          )}
          {recipe.budget && (
            <div class="bg-mv-cream rounded-xl p-3">
              <p class="text-xs text-mv-forest-60">Budget</p>
              <p class="text-base font-semibold text-mv-forest">{budgetLabels[recipe.budget] || recipe.budget}</p>
            </div>
          )}
        </div>

        {(recipe.diet?.length || recipe.season?.length) && (
          <div class="mt-6 flex flex-wrap gap-2">
            {recipe.diet?.map((diet, index) => (
              <span key={index} class="mv-chip mv-chip--accent">
                {dietLabels[diet] || diet}
              </span>
            ))}
            {recipe.season?.map((season, index) => (
              <span key={index} class="mv-chip mv-chip--muted">
                {seasonLabels[season] || season}
              </span>
            ))}
          </div>
        )}
      </div>
    </header>

    <!-- liens majeurs vers pages thématiques -->
    <section class="mb-10 bg-mv-cream rounded-xl p-6">
      <p class="text-mv-forest-80">
        Envie d'autres idées ? Parcourez nos
        <a href="/recettes/thermomix" class="text-mv-leaf underline">recettes Thermomix</a>
        ou nos
        <a href="/recettes/rapides" class="text-mv-leaf underline">recettes rapides</a>.
      </p>
    </section>

    {recipe.highlights && recipe.highlights.length > 0 && (
      <section class="mb-10">
        <h2 class="text-xl sm:text-2xl font-serif font-bold text-mv-forest mb-4">Petites affiches</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {recipe.highlights.map((highlight, index) => (
            <div key={index} class="mv-card p-4 shadow-sm">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">{highlight.icon || '✨'}</span>
                <h3 class="text-base font-semibold text-mv-forest">{highlight.title}</h3>
              </div>
              <p class="text-sm text-mv-forest-70">{highlight.text}</p>
            </div>
          ))}
        </div>
      </section>
    )}

    <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <aside class="lg:col-span-4">
        <div class="bg-mv-cream rounded-2xl p-5 sticky top-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-serif font-bold text-mv-forest">Ingrédients</h2>
            {recipe.servings && (
              <div class="flex items-center gap-2">
                <button id="servings-decrease" class="w-8 h-8 rounded-full border border-mv-leaf-30 text-mv-forest hover:bg-mv-leaf hover:text-mv-cream transition-colors" aria-label="Réduire les portions">-</button>
                <span id="servings-count" class="text-sm font-semibold text-mv-forest">{recipe.servings}</span>
                <button id="servings-increase" class="w-8 h-8 rounded-full border border-mv-leaf-30 text-mv-forest hover:bg-mv-leaf hover:text-mv-cream transition-colors" aria-label="Augmenter les portions">+</button>
              </div>
            )}
          </div>
          <p class="text-xs text-mv-forest-60 mb-4">Ajustez les quantités selon le nombre de personnes.</p>

          {ingredientsWithIndex.length > 0 ? (
            <div class="space-y-4">
              {Object.entries(ingredientGroups).map(([groupName, items]) => (
                <div key={groupName || 'default'}>
                  {groupName && (
                    <h3 class="text-sm font-semibold text-mv-forest mb-2">{groupName}</h3>
                  )}
                  <div class="space-y-2">
                    {items.map((ingredient) => (
                      <div key={ingredient._index} class="flex items-start justify-between gap-3">
                        <div class="text-sm text-mv-forest-80 space-y-1">
                          <p class="font-medium text-mv-forest">{ingredient.name}</p>
                          {(ingredient.quantity || ingredient.unit) && (
                            <span
                              class="ingredient-quantity block text-xs text-mv-forest-60"
                              data-base-quantity={ingredient.quantity}
                              data-base-unit={ingredient.unit}
                            >
                              {ingredient.quantity} {ingredient.unit}
                            </span>
                          )}
                          {ingredient.notes && (
                            <span class="block text-xs text-mv-forest-50">{ingredient.notes}</span>
                          )}
                        </div>
                        <button
                          class="ingredient-add w-8 h-8 rounded-full border border-mv-leaf-30 text-mv-forest hover:bg-mv-leaf hover:text-mv-cream transition-colors"
                          data-ingredient-index={ingredient._index}
                          aria-label={`Ajouter ${ingredient.name} à la liste`}
                        >
                          +
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p class="text-sm text-mv-forest-60">Ingrédients à venir...</p>
          )}
        </div>
      </aside>

      <div class="lg:col-span-8 space-y-6">
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-serif font-bold text-mv-forest mb-4">Instructions</h2>
          {recipe.instructions && recipe.instructions.length > 0 ? (
            hasInstructionLists ? (
              <div class="space-y-4 mv-richtext" set:html={renderPortableText(recipe.instructions)} />
            ) : (
              <div class="space-y-4 mv-richtext">
                {recipe.instructions.map((block, index) => (
                  <div key={index} class="flex items-start gap-3">
                    <span class="mt-1 h-4 w-4 rounded-full border border-mv-leaf-30 bg-mv-cream" aria-hidden="true"></span>
                    <div class="flex-1">
                      <p class="text-xs uppercase tracking-wide text-mv-forest-50 mb-1">Étape {index + 1}</p>
                      <div
                        class="text-sm sm:text-base text-mv-forest-80 leading-relaxed"
                        set:html={renderPortableText([block])}
                      />
                    </div>
                  </div>
                ))}
              </div>
            )
          ) : (
            <p class="text-mv-forest-60 text-sm">Instructions à venir...</p>
          )}
        </div>

        {(recipe.tips?.length || recipe.variations?.length) && (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {recipe.tips?.length > 0 && (
              <div class="bg-mv-cream rounded-xl p-4">
                <h3 class="text-base font-semibold text-mv-forest mb-3">Astuces</h3>
                <ul class="space-y-2 text-sm text-mv-forest-70">
                  {recipe.tips.map((tip, index) => (
                    <li key={index} class="flex items-start gap-2">
                      <span class="text-mv-leaf">•</span>
                      <span>{tip}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {recipe.variations?.length > 0 && (
              <div class="bg-mv-cream rounded-xl p-4">
                <h3 class="text-base font-semibold text-mv-forest mb-3">Variantes</h3>
                <ul class="space-y-2 text-sm text-mv-forest-70">
                  {recipe.variations.map((variation, index) => (
                    <li key={index} class="flex items-start gap-2">
                      <span class="text-mv-leaf">•</span>
                      <span>{variation}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        )}
      </div>
    </section>

    {(hasPracticalInfo || hasNutrition) && (
      <section class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
        {hasPracticalInfo && (
          <div class="mv-card p-5">
            <h3 class="text-lg font-semibold text-mv-forest mb-3">Infos pratiques</h3>
            {recipe.equipment?.length > 0 && (
              <div class="mb-4">
                <p class="text-xs uppercase tracking-wide text-mv-forest-50 mb-2">Matériel</p>
                <div class="flex flex-wrap gap-2">
                  {recipe.equipment.map((item, index) => (
                    <span key={index} class="px-3 py-1 text-xs bg-mv-cream text-mv-forest rounded-full">{item}</span>
                  ))}
                </div>
              </div>
            )}
            {recipe.allergens?.length > 0 && (
              <div class="mb-4">
                <p class="text-xs uppercase tracking-wide text-mv-forest-50 mb-2">Allergènes</p>
                <div class="flex flex-wrap gap-2">
                  {recipe.allergens.map((item, index) => (
                    <span key={index} class="px-3 py-1 text-xs bg-mv-coral-20 text-mv-coral rounded-full">{item}</span>
                  ))}
                </div>
              </div>
            )}
            {recipe.storage && (
              <div>
                <p class="text-xs uppercase tracking-wide text-mv-forest-50 mb-2">Conservation</p>
                <p class="text-sm text-mv-forest-70">{recipe.storage}</p>
              </div>
            )}
          </div>
        )}

        {hasNutrition && (
          <div class="mv-card p-5">
            <h3 class="text-lg font-semibold text-mv-forest mb-3">Nutrition</h3>
            <div class="grid grid-cols-2 gap-3 text-sm text-mv-forest-70">
              {recipe.nutrition?.calories !== undefined && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-mv-forest-50">Calories</p>
                  <p class="text-base font-semibold text-mv-forest">{recipe.nutrition.calories} kcal</p>
                </div>
              )}
              {recipe.nutrition?.protein !== undefined && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-mv-forest-50">Protéines</p>
                  <p class="text-base font-semibold text-mv-forest">{recipe.nutrition.protein} g</p>
                </div>
              )}
              {recipe.nutrition?.carbs !== undefined && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-mv-forest-50">Glucides</p>
                  <p class="text-base font-semibold text-mv-forest">{recipe.nutrition.carbs} g</p>
                </div>
              )}
              {recipe.nutrition?.fat !== undefined && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-mv-forest-50">Lipides</p>
                  <p class="text-base font-semibold text-mv-forest">{recipe.nutrition.fat} g</p>
                </div>
              )}
              {recipe.nutrition?.fiber !== undefined && (
                <div>
                  <p class="text-xs uppercase tracking-wide text-mv-forest-50">Fibres</p>
                  <p class="text-base font-semibold text-mv-forest">{recipe.nutrition.fiber} g</p>
                </div>
              )}
            </div>
          </div>
        )}
      </section>
    )}

    {relatedRecipes.length > 0 && (
      <section class="mt-10">
        <div class="flex items-end justify-between gap-4 mb-4">
          <h2 class="text-2xl font-serif font-bold text-mv-forest">Recettes liées</h2>
          <a href="/recettes/" class="text-sm font-semibold text-mv-forest hover:text-mv-leaf transition-colors">
            Voir toutes les recettes
          </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {relatedRecipes.map((related) => (
            <article class="mv-card p-4">
              <div class="flex items-start gap-4">
                <a href={`/recette/${encodeURIComponent(related.slug)}`} class="block shrink-0 overflow-hidden rounded-lg">
                  {related.image ? (
                    <img
                      src={related.image}
                      alt={related.imageAlt}
                      class="w-24 h-24 sm:w-28 sm:h-28 object-cover transition-transform duration-300 hover:scale-[1.03]"
                      loading="lazy"
                      decoding="async"
                      width="320"
                      height="320"
                      sizes="112px"
                    />
                  ) : (
                    <div class="w-24 h-24 sm:w-28 sm:h-28 bg-gradient-to-br from-mv-cream to-mv-leaf-20" aria-hidden="true"></div>
                  )}
                </a>
                <div class="min-w-0 flex-1">
                  <p class="text-xs uppercase tracking-[0.12em] text-mv-forest-60 mb-2">{related.relationLabel}</p>
                  <h3 class="text-lg font-semibold text-mv-forest">
                    <a href={`/recette/${encodeURIComponent(related.slug)}`} class="hover:text-mv-leaf transition-colors">
                      {related.title}
                    </a>
                  </h3>
                  <p class="text-sm text-mv-forest-70 mt-1">{related.category}</p>
                  <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-mv-forest-70">
                    <a href={`/recette/${encodeURIComponent(related.slug)}`} class="underline underline-offset-4 hover:text-mv-leaf">
                      Ouvrir la recette
                    </a>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      </section>
    )}

    <nav class="mt-12 text-center">
      <a
        href="/recettes"
        class="mv-btn mv-btn-primary bg-mv-leaf text-mv-cream hover:bg-mv-forest transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-mv-leaf focus:ring-offset-2 shadow-md hover:shadow-lg"
        aria-label="Retour à la liste des recettes"
      >
        ← Retour aux recettes
      </a>
    </nav>
  </article>

  <script define:vars={{
    ingredients: recipe.ingredients || [],
    baseServings: recipe.servings || 0,
    recipeTitle: recipe.title
  }}>
    const parseQuantity = (value) => {
      if (value === null || value === undefined) return null;
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      const raw = value.toString().trim().replace(',', '.');
      if (!raw) return null;

      const mixed = raw.match(/^(\d+)\s+(\d+)\/(\d+)$/);
      if (mixed) {
        const whole = Number(mixed[1]);
        const num = Number(mixed[2]);
        const den = Number(mixed[3]);
        if (den) return whole + num / den;
      }

      const fraction = raw.match(/^(\d+)\/(\d+)$/);
      if (fraction) {
        const num = Number(fraction[1]);
        const den = Number(fraction[2]);
        if (den) return num / den;
      }

      const numeric = Number(raw);
      if (!Number.isNaN(numeric)) return numeric;
      return null;
    };

    const formatQuantity = (value) => {
      if (value === null || value === undefined || Number.isNaN(value)) return '';
      const rounded = Math.round(value * 100) / 100;
      return rounded.toString().replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
    };

    const getScaledIngredients = (factor) => {
      return ingredients.map((ingredient) => {
        const numeric = parseQuantity(ingredient.quantity);
        if (numeric !== null) {
          return {
            ...ingredient,
            quantity: formatQuantity(numeric * factor)
          };
        }
        return ingredient;
      });
    };

    const updateIngredientQuantities = (factor) => {
      document.querySelectorAll('.ingredient-quantity').forEach((el) => {
        const baseQuantity = el.dataset.baseQuantity;
        const baseUnit = el.dataset.baseUnit || '';
        const numeric = parseQuantity(baseQuantity);
        if (numeric === null) return;
        const scaled = formatQuantity(numeric * factor);
        el.textContent = baseUnit ? `${scaled} ${baseUnit}` : scaled;
      });
    };

    const showToast = (message) => {
      const toast = document.createElement('div');
      toast.className = 'fixed top-24 right-4 bg-mv-forest text-mv-cream px-4 py-2 rounded-lg shadow-lg z-50 animate-in slide-in-from-right-2';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('animate-out', 'slide-out-to-right-2');
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    };

    document.addEventListener('DOMContentLoaded', () => {
      let currentServings = baseServings || 0;
      const countEl = document.getElementById('servings-count');
      const decreaseBtn = document.getElementById('servings-decrease');
      const increaseBtn = document.getElementById('servings-increase');

      if (countEl && currentServings > 0) {
        countEl.textContent = currentServings.toString();
      }

      const applyServings = () => {
        if (!baseServings || !countEl) return;
        const factor = currentServings / baseServings;
        countEl.textContent = currentServings.toString();
        updateIngredientQuantities(factor);
      };

      if (decreaseBtn) {
        decreaseBtn.addEventListener('click', () => {
          if (currentServings > 1) {
            currentServings -= 1;
            applyServings();
          }
        });
      }

      if (increaseBtn) {
        increaseBtn.addEventListener('click', () => {
          currentServings += 1;
          applyServings();
        });
      }

      const addAllBtn = document.getElementById('add-all-ingredients');
      if (addAllBtn) {
        addAllBtn.addEventListener('click', () => {
          const factor = baseServings ? currentServings / baseServings : 1;
          const scaled = getScaledIngredients(factor);
          if (window.ShoppingListManager) {
            window.ShoppingListManager.addIngredients(scaled, { sourceTitle: recipeTitle });
          } else {
            window.dispatchEvent(new CustomEvent('addToShoppingList', { detail: { ingredients: scaled, recipeTitle } }));
          }
        });
      }

      document.querySelectorAll('.ingredient-add').forEach((button) => {
        button.addEventListener('click', () => {
          const index = Number(button.dataset.ingredientIndex);
          const factor = baseServings ? currentServings / baseServings : 1;
          const scaled = getScaledIngredients(factor);
          const ingredient = scaled[index];
          if (!ingredient) return;

          if (window.ShoppingListManager) {
            window.ShoppingListManager.addIngredients([ingredient], { sourceTitle: recipeTitle });
          } else {
            window.dispatchEvent(new CustomEvent('addToShoppingList', { detail: { ingredients: [ingredient], recipeTitle } }));
          }
        });
      });

      const copyBtn = document.getElementById('copy-recipe-link');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            showToast('Lien copié !');
          } catch {
            showToast('Impossible de copier le lien.');
          }
        });
      }

    });
  </script>
    </>
  )}
</MainLayout>
