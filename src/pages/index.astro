---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/Section.astro';
import PricingCard from '../components/PricingCard.astro';
import RestaurantSection from '../components/RestaurantSection.astro';
import {
  getHomeData,
  getLocationsData,
  getRestaurantData,
  type LocationData,
} from '../lib/sanity';

// Récupérer les données depuis Sanity (en parallèle pour réduire le TTFB)
const [locations, restaurantData, homeData] = await Promise.all([
  getLocationsData(),
  getRestaurantData(),
  getHomeData(),
]);

const fallbackHeroDescription = "À Wavre, à 1 km de la E411, Gastronomade accueille réunions, événements privés et dîners. Un cadre naturel, chaleureux et simple d’accès.";

// Organiser les locations par type
const hasLocationData = locations.length > 0
const visibleLocations = locations.filter(loc => loc.isVisible !== false);
const societeLocations = visibleLocations.filter(loc => loc.type === 'societe');
const priveLocations = visibleLocations.filter(loc => loc.type === 'prive');

const fallbackRestaurantDates = [
  '2026-03-05',
  '2026-03-19',
  '2026-04-09',
  '2026-04-23',
  '2026-05-07',
  '2026-05-21'
];

const toIsoDate = (value?: string) => {
  if (!value) return undefined;
  const trimmed = value.split('T')[0];
  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(trimmed)) {
    return trimmed;
  }
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) return undefined;
  return parsed.toISOString();
};

const baseUrl = Astro.site ? Astro.site.toString().replace(/\/$/, '') : Astro.url.origin;

const restaurantDateSlots = (restaurantData?.dateSlots && restaurantData.dateSlots.length > 0)
  ? restaurantData.dateSlots.filter((slot) => slot?.isVisible !== false)
  : [];

const restaurantSlots = (restaurantDateSlots.length > 0 ? restaurantDateSlots : fallbackRestaurantDates.map(date => ({
  date,
  status: 'Disponible'
})))
  .slice(0, 8)
  .map(slot => ({
    date: slot?.date,
    status: slot?.status || 'Disponible'
  }))

const showRestaurant = restaurantData?.isVisible !== false


const restaurantEventsJsonLd = showRestaurant
  ? restaurantSlots
      .filter((slot) => slot?.date)
      .map((slot) => {
        const startDate = toIsoDate(slot?.date);
        if (!startDate) return null;
        const isFull = (slot?.status || '').toLowerCase().includes('complet');
        return {
          "@context": "https://schema.org",
          "@type": "Event",
          "name": restaurantData?.title || "Restaurant éphémère",
          "description": restaurantData?.menuDescription || homeData?.restaurantSectionDescription,
          "startDate": startDate,
          "eventStatus": "https://schema.org/EventScheduled",
          "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
          "location": {
            "@type": "Place",
            "name": "Gastronomade",
            "address": "Wavre, Belgique"
          },
          "offers": {
            "@type": "Offer",
            "price": typeof restaurantData?.price === 'number' ? restaurantData.price : undefined,
            "priceCurrency": "EUR",
            "availability": isFull ? "https://schema.org/SoldOut" : "https://schema.org/InStock",
            "url": `${baseUrl}/#restaurant-section`
          },
          "organizer": {
            "@type": "Organization",
            "name": "Gastronomade",
            "url": baseUrl
          }
        };
      })
      .filter(Boolean)
  : [];

const heroBackgroundUrl = homeData?.heroBackgroundImage?.asset?.url
const homeHero = homeData?.hero
const homeHeroBackgroundUrl = homeHero?.imageUrl || heroBackgroundUrl
const homeHeroKicker = homeHero?.kicker || homeData?.heroSubtitle || 'Gastronomade'
const homeHeroTitle = homeHero?.title || homeData?.heroTitle || 'Un lieu d’exception pour vos rencontres.'
const homeHeroSubtitle = homeHero?.subtitle || homeData?.heroDescription || fallbackHeroDescription
const homeHeroCtaCountRaw = Number(homeHero?.ctaCount ?? 2)
const homeHeroCtaCount = homeHeroCtaCountRaw >= 2 ? 2 : 1
const homeHeroPrimaryCtaLabel = homeHero?.primaryCtaLabel || 'Réserver une date'
const homeHeroPrimaryCtaUrl = homeHero?.primaryCtaUrl || '/contact'
const homeHeroSecondaryCtaLabel = homeHero?.secondaryCtaLabel || 'Découvrir les offres'
const homeHeroSecondaryCtaUrl = homeHero?.secondaryCtaUrl || '#location-section'
const pageDescription = (homeData?.heroDescription || fallbackHeroDescription).trim();
const pageImage = heroBackgroundUrl
  ? `${heroBackgroundUrl}?w=1200&h=630&fit=crop&auto=format`
  : undefined;
const locationGallery = (homeData?.locationGallery || []).filter((image) => image?.url)
const whyHereItems = [
  "En pleine nature, à 1 km de la E411",
  "Maison en bois, chauffée au poêle",
  "Jusqu’à 12 personnes",
  "Terrasse et parking facile"
]

const buildLocationFeatures = (location?: LocationData) => {
  const base = location?.features || []
  const details = location?.details || []
  return [...base, ...details]
}
---

<MainLayout
  title={homeData?.title || "Gastronomade - Manger Vrai | Muriel Cruysmans"}
  description={pageDescription}
  image={pageImage}
  jsonLd={restaurantEventsJsonLd}
>
  <!-- Hero Section -->
  <Section class="relative overflow-hidden bg-white fade-in-up" role="banner">
    {homeHeroBackgroundUrl && (
      <div class="pointer-events-none absolute inset-0 hidden lg:block">
        <div
          class="absolute inset-y-0 right-0 w-2/3 bg-cover bg-center hero-image-mask"
          style={`background-image: url(${homeHeroBackgroundUrl}?w=1800&auto=format);`}
          aria-hidden="true"
        />
        <div
          class="absolute inset-y-0 right-0 w-2/3 bg-[linear-gradient(to_left,transparent_0%,transparent_33%,rgba(255,255,255,0.6)_52%,rgba(255,255,255,0.92)_72%,white_100%)]"
          aria-hidden="true"
        />
      </div>
    )}
    <div class="relative z-10" slot="content">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-center">
        <div class="lg:col-span-7 space-y-5 sm:space-y-6">
          <p class="mv-kicker">{homeHeroKicker}</p>
          <h1 class="mv-hero-title max-w-3xl">
            {homeHeroTitle}
          </h1>
          <p class="mv-hero-subtitle max-w-3xl text-mv-forest-80">
            {homeHeroSubtitle}
          </p>
          <div class="flex flex-wrap gap-3 pt-1">
            <a
              href={homeHeroPrimaryCtaUrl}
              class="mv-btn mv-btn-primary bg-mv-forest text-white shadow-lg hover:bg-mv-plum transition"
            >
              {homeHeroPrimaryCtaLabel}
            </a>
            {homeHeroCtaCount === 2 && homeHeroSecondaryCtaLabel && homeHeroSecondaryCtaUrl && (
              <a
                href={homeHeroSecondaryCtaUrl}
                class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream"
              >
                {homeHeroSecondaryCtaLabel}
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </Section>

  <!-- Gastronomade Section -->
  <Section class="bg-white fade-in-up scroll-fade-in" id="location-section" tight={true}>
    <div class="max-w-3xl" slot="content">
      <p class="mv-kicker">Deux expériences</p>
      <h2 class="mv-section-title">
        {homeData?.locationSectionTitle || 'Privatisation & restaurant éphémère'}
      </h2>
      <p class="mv-lead text-mv-forest-70">
        {homeData?.locationSectionDescription || 'Deux offres complémentaires, un même esprit : chaleur, nature et cuisine sincère.'}
      </p>
    </div>

    <div class="relative mt-10" slot="content">
      <div class="pointer-events-none absolute -top-10 left-10 h-24 w-24 rounded-full bg-mv-leaf-10 blur-3xl"></div>
      <div class="pointer-events-none absolute -bottom-10 right-6 h-28 w-28 rounded-full bg-mv-coral-20 blur-3xl"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 items-start">
        <!-- Sociétés -->
          <div class="scroll-slide-in-left">
            {societeLocations.length > 0 ? (
              <PricingCard
                title={societeLocations[0].title}
                subtitle={societeLocations[0].subtitle || "Réunions & Team-Buildings"}
                price={societeLocations[0].price}
                period="HTVA"
                features={buildLocationFeatures(societeLocations[0])}
                imageUrl={societeLocations[0].imageUrl ? `${societeLocations[0].imageUrl}?w=600&h=400&fit=crop&auto=format` : undefined}
                imageAlt={societeLocations[0].title}
                ctaText="Voir l’offre entreprises"
                ctaLink="/privatisation-entreprise-wavre"
              />
            ) : !hasLocationData ? (
              <PricingCard
                title="Sociétés"
                subtitle="Réunions & Team-Buildings"
                price="400€"
                period="HTVA"
                features={[]}
                ctaText="Voir l’offre entreprises"
                ctaLink="/privatisation-entreprise-wavre"
              />
            ) : null}
          </div>

          <!-- Privé -->
          <div class="scroll-fade-in">
            {priveLocations.length > 0 ? (
              <PricingCard
                title={priveLocations[0].title}
                subtitle={priveLocations[0].subtitle || "Événements privés"}
                price={priveLocations[0].price}
                period="HTVA"
                features={buildLocationFeatures(priveLocations[0])}
                imageUrl={priveLocations[0].imageUrl ? `${priveLocations[0].imageUrl}?w=600&h=400&fit=crop&auto=format` : undefined}
                imageAlt={priveLocations[0].title}
                ctaText={priveLocations[0].ctaLabel || "Organiser mon événement"}
                ctaLink="/evenements-prives-wavre"
              />
            ) : !hasLocationData ? (
              <PricingCard
                title="Privé"
                subtitle="Événements privés"
                price="400€"
                period="HTVA"
                features={[]}
                ctaText="Organiser mon événement"
                ctaLink="/evenements-prives-wavre"
              />
            ) : null}
          </div>

          <!-- Restaurant -->
          {showRestaurant && (
            <div class="scroll-slide-in-right">
              <PricingCard
                title={restaurantData?.title || "Restaurant éphémère"}
                subtitle={restaurantData?.subtitle || "Un jeudi par mois"}
                price={restaurantData?.price ? `${restaurantData.price}€` : "50€"}
                period="/pers."
                features={restaurantData?.highlights || []}
                ctaText="Voir les prochaines dates"
                ctaLink="/restaurant-wavre#restaurant-section"
                imageUrl={restaurantData?.imageUrl ? `${restaurantData.imageUrl}?w=600&h=400&fit=crop&auto=format` : undefined}
                imageAlt={restaurantData?.imageAlt || restaurantData?.title || "Restaurant éphémère"}
                highlight="true"
              />
            </div>
          )}
      </div>
    </div>

    {locationGallery.length > 0 && (
      <div class="mt-10" slot="content">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between mb-5">
          <div>
            <p class="mv-kicker">Le lieu en images</p>
            <h3 class="text-xl sm:text-2xl font-serif font-semibold text-mv-forest">
              Découvrez l’atmosphère
            </h3>
          </div>
          <p class="text-sm text-mv-forest-60 max-w-lg">
            Lumière naturelle, table conviviale, coins cosy et espaces modulables.
          </p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {locationGallery.slice(0, 6).map((image, index) => {
            const imageCardClass = index === 0
              ? 'group relative overflow-hidden rounded-2xl border border-mv-leaf-20 bg-mv-cream-80 sm:col-span-2 lg:col-span-2'
              : 'group relative overflow-hidden rounded-2xl border border-mv-leaf-20 bg-mv-cream-80';
            return (
              <figure class={imageCardClass}>
                <img
                  src={`${image.url}?w=900&h=600&fit=crop&auto=format`}
                  alt={image.alt || 'Photo du lieu'}
                  class="h-56 sm:h-64 w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                  decoding="async"
                  width="900"
                  height="600"
                  sizes="(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-mv-cream/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                {image.alt && (
                  <figcaption class="absolute bottom-3 left-3 rounded-full bg-mv-cream-80 px-3 py-1 text-xs uppercase tracking-[0.18em] text-mv-forest-70">
                    {image.alt}
                  </figcaption>
                )}
              </figure>
            );
          })}
        </div>
      </div>
    )}

    <div class="mt-8 w-full" slot="content">
      <div class="rounded-2xl border border-mv-leaf-10 bg-white/70 px-4 py-3">
        <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-50 mb-3 text-center">
          Pourquoi ici ?
        </p>
        <ul class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-xs sm:text-sm text-mv-forest-70 w-full">
          {whyHereItems.map((feature) => (
            <li class="flex items-center justify-center gap-2 text-center">
              <span class="h-1 w-1 rounded-full bg-mv-leaf/60" aria-hidden="true"></span>
              <span>{feature}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </Section>

  <!-- Restaurant Section -->
  {showRestaurant && (
    <RestaurantSection
      id="restaurant-section"
      sectionClass="bg-white scroll-fade-in"
      restaurantData={restaurantData}
      homeData={homeData}
      ctaHref="/contact"
    />
  )}


  <Section class="bg-white scroll-fade-in">
    <div class="max-w-3xl" slot="content">
      <p class="mv-kicker">À propos</p>
      <h2 class="mv-section-title">Muriel, bio et accompagnements</h2>
      <p class="mv-lead text-mv-forest-70">
        Découvrez le parcours de Muriel, puis les formats Cours & Coaching pour choisir l’accompagnement le plus adapté.
      </p>
    </div>

    <div class="mt-6 flex flex-wrap gap-3" slot="content">
      <a
        href="/auteur"
        class="mv-btn mv-btn-primary bg-mv-forest text-mv-cream hover:bg-mv-leaf"
      >
        Voir la bio de Muriel
      </a>
      <a
        href="/about"
        class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream"
      >
        Voir Cours & Coaching
      </a>
    </div>
  </Section>
</MainLayout>
