---
import MainLayout from '../layouts/MainLayout.astro';
import SimpleRecipeFilters from '../components/SimpleRecipeFilters.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import EnhancedRecipeCard from '../components/EnhancedRecipeCard.astro';
import MicroInteractions from '../components/MicroInteractions.astro';
import SpacingOptimizer from '../components/SpacingOptimizer.astro';
import ShoppingList from '../components/ShoppingList.astro';
import FavoritesManager from '../components/FavoritesManager.astro';
import LazyImage from '../components/LazyImage.astro';
import AnimationOptimizer from '../components/AnimationOptimizer.astro';
import { getRecipesData, type RecipeData } from '../lib/sanity';

// R√©cup√©rer les recettes depuis Sanity
const recipes = await getRecipesData();

// R√©cup√©rer les param√®tres de filtrage depuis l'URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('search') || '';
const selectedCategory = url.searchParams.get('category') || '';
const selectedDifficulty = url.searchParams.get('difficulty') || '';
const selectedTags = url.searchParams.getAll('tags');

// Fonction pour filtrer les recettes
function filterRecipes(recipes: RecipeData[], filters: { search: string; category: string; difficulty: string; tags: string[] }) {
  return recipes.filter(recipe => {
    // Recherche textuelle
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      const matchesSearch =
        recipe.title.toLowerCase().includes(searchLower) ||
        recipe.description?.toLowerCase().includes(searchLower) ||
        recipe.ingredients?.some(ing => ing.name.toLowerCase().includes(searchLower));
      if (!matchesSearch) return false;
    }

    // Filtre par cat√©gorie
    if (filters.category && recipe.category !== filters.category) {
      return false;
    }

    // Filtre par difficult√©
    if (filters.difficulty && recipe.difficulty !== filters.difficulty) {
      return false;
    }

    // Filtre par tags
    if (filters.tags.length > 0) {
      const recipeTags = recipe.tags || [];
      const hasMatchingTag = filters.tags.some(filterTag =>
        recipeTags.some(recipeTag => recipeTag.toLowerCase().includes(filterTag.toLowerCase()))
      );
      if (!hasMatchingTag) return false;
    }

    return true;
  });
}

// Pour le filtrage dynamique, on passe toutes les recettes au composant
const allRecipes = recipes;

// Fonction pour obtenir le nom de la cat√©gorie
function getCategoryName(category: string): string {
  const categories: { [key: string]: string } = {
    'entree': 'Entr√©e',
    'plat': 'Plat principal',
    'dessert': 'Dessert',
    'boisson': 'Boisson',
    'accompagnement': 'Accompagnement'
  };
  return categories[category] || category;
}

// Extraire tous les tags uniques de toutes les recettes
const allTags = new Set<string>();
allRecipes.forEach(recipe => {
  if (recipe.tags) {
    recipe.tags.forEach(tag => allTags.add(tag));
  }
});
const uniqueTags = Array.from(allTags).sort();

// Pr√©parer les donn√©es pour les composants
const recipeCardsData = allRecipes.map(recipe => ({
  id: recipe._id,
  slug: recipe.slug?.current || recipe._id,
  title: recipe.title,
  description: recipe.description,
  image: recipe.featuredImageUrl ? `${recipe.featuredImageUrl}?w=400&h=300&fit=crop&auto=format` : undefined,
  prepTime: recipe.prepTime,
  cookTime: recipe.cookTime,
  difficulty: recipe.difficulty,
  category: recipe.category,
  rating: recipe.rating || 4.5,
  isNew: recipe.isNew || false,
  isPopular: recipe.isPopular || false,
  tags: recipe.tags,
  ingredients: recipe.ingredients ? recipe.ingredients.map(ing => ing.name) : []
}));

// Fil d'Ariane
const breadcrumbs = [
  { label: 'Accueil', href: '/' },
  { label: 'Recettes', current: true }
];
---

<MainLayout title="Recettes - Gastronomade">
  <!-- Optimisation d'espacement et micro-interactions -->
  <SpacingOptimizer enableResponsiveSpacing={true} enableDynamicSpacing={true} />
  <MicroInteractions enableHoverEffects={true} enableClickFeedback={true} enableScrollAnimations={true} enableLoadingAnimations={true} />
  <AnimationOptimizer enablePerformanceMode={true} enableReducedMotion={true} />
  <FavoritesManager />
  <ShoppingList />

  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-mv-cream to-white py-12 sm:py-16 lg:py-20 scroll-fade-in" role="banner">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-serif font-bold text-mv-forest mb-3 sm:mb-4 leading-tight">
        Recettes
      </h1>
      <p class="text-lg sm:text-xl md:text-2xl text-mv-plum mb-4 sm:mb-6 max-w-3xl mx-auto leading-relaxed">
        D√©couvrez mes recettes saines et savoureuses
      </p>
    </div>
  </section>

  <!-- Recipes Section -->
  <section class="py-0 bg-white scroll-fade-in">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumbs -->
      <Breadcrumbs items={breadcrumbs} />

      <!-- Recipe Filters -->
      <SimpleRecipeFilters
        currentFilters={{
          search: searchQuery,
          category: selectedCategory,
          difficulty: selectedDifficulty,
          tags: selectedTags
        }}
        availableTags={uniqueTags}
        totalRecipes={allRecipes.length}
      />

      {allRecipes && allRecipes.length > 0 ? (
        <!-- Enhanced Recipes Grid -->
        <div id="recipes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8" role="grid">
          {recipeCardsData.map((recipe, index) => (
            <div class={`scroll-fade-in ${index % 2 === 0 ? 'scroll-slide-in-left' : 'scroll-slide-in-right'}`} style={`animation-delay: ${index * 0.1}s`}>
              <EnhancedRecipeCard
                recipe={{
                  ...recipe,
                  category: getCategoryName(recipe.category)
                }}
                showFavoriteButton={true}
                showShoppingListButton={true}
                compact={false}
              />
            </div>
          ))}
        </div>
      ) : (
        <!-- Recipes Coming Soon -->
        <div class="text-center py-16 scroll-fade-in">
          <div class="max-w-2xl mx-auto">
            <svg class="mx-auto h-24 w-24 text-mv-forest-doux mb-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <h2 class="text-3xl font-serif font-bold text-mv-forest mb-4">
              Recettes √† venir
            </h2>
            <p class="text-lg text-mv-forest-80 mb-8">
              Je pr√©pare une collection de recettes saines et d√©licieuses pour vous accompagner dans votre voyage culinaire.
            </p>
            <div class="bg-mv-cream rounded-lg p-6 inline-block">
              <p class="text-mv-forest-80">
                <strong>Prochainement :</strong> Recettes connect√©es au CMS pour une exp√©rience interactive
              </p>
            </div>
          </div>
        </div>

        <!-- Recipe Preview Cards -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mt-12">
          <!-- Recipe Card 1 -->
          <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-mv-leaf-20 hover-lift click-feedback">
            <div class="aspect-video bg-mv-cream flex items-center justify-center">
              <div class="text-center text-mv-forest-60">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Salade d'√©t√© aux herbes
              </h3>
              <p class="text-mv-forest-80 mb-4">
                Une salade fra√Æche et l√©g√®re, parfaite pour les journ√©es ensoleill√©es.
              </p>
              <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span>‚è±Ô∏è 15 min</span>
                <span>üë• 4 pers.</span>
                <span>üìä Facile</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest-doux text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-bois-clair text-gray-800 text-xs rounded-full">Rapide</span>
              </div>
            </div>
          </div>

          <!-- Recipe Card 2 -->
          <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 hover-lift click-feedback">
            <div class="aspect-video bg-gray-200 flex items-center justify-center">
              <div class="text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Soupe de l√©gumes d'automne
              </h3>
              <p class="text-gray-600 mb-4">
                Un velout√© r√©confortant aux saveurs d'automne, riche en nutriments.
              </p>
              <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span>‚è±Ô∏è 45 min</span>
                <span>üë• 6 pers.</span>
                <span>üìä Moyen</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest-doux text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-naturel text-white text-xs rounded-full">Thermomix</span>
              </div>
            </div>
          </div>

          <!-- Recipe Card 3 -->
          <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 hover-lift click-feedback">
            <div class="aspect-video bg-gray-200 flex items-center justify-center">
              <div class="text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Quinoa aux l√©gumes grill√©s
              </h3>
              <p class="text-gray-600 mb-4">
                Un plat complet et √©quilibr√©, source de prot√©ines v√©g√©tales.
              </p>
              <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span>‚è±Ô∏è 30 min</span>
                <span>üë• 4 pers.</span>
                <span>üìä Facile</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest-doux text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-bois-clair text-gray-800 text-xs rounded-full">Rapide</span>
                <span class="px-2 py-1 bg-naturel text-white text-xs rounded-full">Saison</span>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  </section>
</MainLayout>