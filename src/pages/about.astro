---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/Section.astro';
import PricingCard from '../components/PricingCard.astro';
import { sanityClient, queries, type AboutData } from '../lib/sanity';

// Fonction helper pour obtenir l'URL d'une image Sanity
function getImageUrl(image: any): string | null {
  if (!image) return null;

  // Si c'est déjà une string, la retourner
  if (typeof image === 'string') return image;

  // Structure après déréférencement: { asset: { url: string } }
  if (image.asset?.url) return image.asset.url;

  // Structure alternative
  if (image.url) return image.url;

  return null;
}

// Récupérer les données depuis Sanity
const aboutData = await sanityClient.fetch<AboutData>(queries.about);

const showHero = aboutData?.showHero !== false;
const showVision = aboutData?.showVision !== false;
const showAboutSection = aboutData?.showAboutSection !== false;
const showAchievements = aboutData?.showAchievements !== false;
const showServices = aboutData?.showServices !== false;
const showJourney = aboutData?.showJourney !== false;
const showSignature = aboutData?.showSignature !== false;

const fallbackAboutLead = 'Introduire du plaisir et du bon sens en respectant les principes d’une nutrition équilibrée.';
const fallbackBio = 'Je suis passionnée par l’alimentation depuis une vingtaine d’années et convaincue que c’est un des piliers de notre bonne santé.';
const legacyBio = 'Passionnée de cuisine santé et de bien‑être, Muriel Cruysmans transmet une approche simple, sensible et généreuse de l’alimentation. Elle aime cuisiner en quantité, partager et donner envie de mieux manger, sans rigidité.';
const fallbackAboutParagraphs = [
  'Bien s’alimenter oui, mais dans le respect du travail et de la planète. Je privilégie les produits locaux, de saison, de culture biologique. Ma cuisine se veut simple, savoureuse, fraîche, nourrissante et conviviale. Rien n’est interdit, c’est en prenant conscience de notre manière de nous alimenter et en découvrant de délicieuses nouvelles alternatives que petit à petit les aliments indésirables sortent de nos assiettes.'
];
const fallbackHeroSubtitle = "Une cuisine saine, vivante et joyeuse, pour apprendre à cuisiner simplement et mieux manger au quotidien.";
const fallbackJourneyItems = [
  'Ma curiosité, ma gourmandise et mon envie de comprendre m’ont mené à travers de nombreuses conférences, formations et cours de cuisine (CERDEN, Taty Lauwers, Pol Grégoire, Coaching, pleine conscience, Formation potager, Cuisine sauvage et l’accès à la profession de traiteur-restaurateur).',
  'J’ai mis en pratique tout ce savoir à travers des cours de cuisine (notamment à la Vie-Là à Ottignies), des animations au goût dans les écoles, des créations de recettes pour une nutritionniste, la publication de mon livre de recettes « Et si on mangeait vrai ? », la livraison de plats ressourçant et Gastronomade (notre restaurant et lieu mis en location).'
];
const fallbackSignatureParagraphs = [
  'L’important est de trouver l’équilibre. Chacun a le sien et il est toujours à moduler.',
  'Je ne suis « anti » rien. C’est juste le bon sens qui a fait sortir de mon assiette tous les produits industriels, chémiqués, ....qui ne sont plus des aliments mais de la « bouffe ».',
  'Quel plaisir d’offrir un festival de goûts, de textures et de saveurs à nos papilles à partir de produits simples, frais et naturels.'
];

const visionCards = (aboutData?.visionCards && aboutData.visionCards.length > 0)
  ? aboutData.visionCards
  : [
      {
        label: 'Santé',
        title: 'Équilibre & vitalité',
        text: 'Des recettes accessibles, bonnes et saines, pour retrouver énergie et plaisir sans pression.',
        isVisible: true
      },
      {
        label: 'Transmission',
        title: 'Apprendre en faisant',
        text: 'Des gestes simples, des repères clairs, pour gagner en autonomie et en confiance.',
        isVisible: true
      },
      {
        label: 'Plaisir',
        title: 'Cuisine vivante',
        text: 'Végétal, saison, gourmandise : une cuisine qui fait du bien et qui rassemble.',
        isVisible: true
      }
    ];

const aboutLead = aboutData?.aboutLead ?? fallbackAboutLead;
const aboutParagraphs = aboutData?.aboutParagraphs ?? fallbackAboutParagraphs;
const journeyItems = aboutData?.journeyItems ?? fallbackJourneyItems;
const signatureParagraphs = aboutData?.signatureParagraphs ?? fallbackSignatureParagraphs;
const rawBio = aboutData?.bio ?? fallbackBio;
const resolvedBio = rawBio === legacyBio ? fallbackBio : rawBio;
const aboutCtaLabel = aboutData?.aboutCtaLabel || "Voir les services";
const aboutCtaLink = aboutData?.aboutCtaLink || "#services";
const pageDescription = (aboutData?.heroSubtitle || aboutData?.aboutLead || fallbackHeroSubtitle).trim();
const pageImage = getImageUrl(aboutData?.photo)
  ? `${getImageUrl(aboutData?.photo)}?w=1200&h=630&fit=crop&auto=format`
  : undefined;
---

<MainLayout
  title={aboutData?.title || "Cours & Coaching - Muriel Cruysmans"}
  description={pageDescription}
  image={pageImage}
>
  <!-- Hero Section -->
  {showHero && (
    <Section class="relative z-0 overflow-visible bg-mv-cream" containerClass="relative z-0">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 items-center" slot="content">
        <div class="lg:col-span-7 space-y-4 relative z-10">
          <h1 class="mv-hero-title">
            {aboutData?.heroTitle || "Cours & coaching personnalisés"}
          </h1>
          <p class="mv-hero-subtitle text-mv-forest-80">
            {aboutData?.heroSubtitle || "Une cuisine saine, vivante et joyeuse, pour apprendre à cuisiner simplement et mieux manger au quotidien."}
          </p>
          <div class="flex flex-wrap gap-3 pt-2">
            <a href={aboutData?.heroCtaLink || "/contact"} class="mv-btn mv-btn-primary bg-mv-forest text-mv-cream hover:bg-mv-leaf">
              {aboutData?.heroCtaLabel || "Mes services"}
            </a>
          </div>
        </div>
      </div>
    </Section>
  )}

  <!-- Vision Section -->
  {showVision && (
    <Section id="vision" class="bg-white" containerClass="max-w-5xl">
      <div class="max-w-3xl" slot="content">
        <p class="mv-kicker">{aboutData?.visionKicker || "Vision"}</p>
        <h2 class="mv-section-title">
          {aboutData?.visionTitle || "Ma vision de la cuisine"}
        </h2>
        <p class="mv-lead text-mv-forest-70">
          {aboutData?.visionText || "Je crois à une cuisine simple, locale et profondément humaine — une cuisine qui nourrit le corps, apaise l’esprit et crée du lien."}
        </p>
      </div>

      <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6" slot="content">
        {visionCards.filter((card) => card?.isVisible !== false).map((card, index) => (
          <div class="mv-card p-5 sm:p-6" key={index}>
            <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-50">{card.label}</p>
            <h3 class="mt-2 text-lg font-serif font-semibold text-mv-forest">{card.title}</h3>
            <p class="mt-2 text-sm text-mv-forest-70">
              {card.text}
            </p>
          </div>
        ))}
      </div>
    </Section>
  )}

  <!-- About Muriel Section -->
  {showAboutSection && (
    <Section class="bg-mv-cream relative z-20" containerClass="max-w-6xl">
      <div class="text-center mb-6 sm:mb-8 lg:mb-10" slot="content">
        <h2 class="mv-section-title mb-3 sm:mb-4">
          {aboutData?.aboutTitle || "Muriel, cuisine & transmission"}
        </h2>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8 lg:gap-10 items-start" slot="content">
        <div class="lg:col-span-7 space-y-6">
          {aboutLead && (
            <div class="rounded-3xl border border-mv-leaf-30 bg-mv-cream-50 px-5 py-5 sm:px-6 sm:py-6">
              <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-60">Ma boussole</p>
              <p class="mt-3 text-xl sm:text-2xl font-serif font-semibold text-mv-forest leading-snug">
                {aboutLead}
              </p>
            </div>
          )}
          <div class="mv-card p-6 sm:p-8">
            <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-60">Qui je suis</p>
            <p class="mt-3 text-base sm:text-lg text-mv-forest-80 leading-relaxed">
              {resolvedBio}
            </p>
          </div>
          {!showAchievements && (
            <a href={aboutCtaLink} class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream">
              {aboutCtaLabel}
            </a>
          )}
        </div>
        <div class="lg:col-span-5 space-y-6">
          <div class="bg-mv-cream rounded-3xl p-4 sm:p-6 shadow-sm border border-mv-leaf-20">
            {getImageUrl(aboutData?.photo) ? (
              <img
                src={`${getImageUrl(aboutData?.photo)}?w=500&h=600&fit=crop&auto=format`}
                alt="Muriel Cruysmans"
                class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-2xl"
                loading="lazy"
                decoding="async"
                width="500"
                height="600"
                sizes="(min-width: 1024px) 40vw, (min-width: 640px) 60vw, 100vw"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              />
            ) : null}
            <div class="aspect-[4/5] bg-mv-cream-80 border border-mv-leaf-20 rounded-2xl flex items-center justify-center" style={getImageUrl(aboutData?.photo) ? 'display: none;' : 'display: flex;'}>
              <div class="text-center text-mv-forest-60">
                <svg class="mx-auto h-12 sm:h-16 w-12 sm:w-16 mb-3 sm:mb-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <p class="text-sm sm:text-base font-medium">Photo Muriel Cruysmans</p>
                <p class="text-xs sm:text-sm mt-1 sm:mt-2">Ajoutez une photo dans le Sanity Studio</p>
              </div>
            </div>
          </div>
          {showAchievements && (
            <div class="mv-card p-6 sm:p-8">
              <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-60">Repères</p>
              <div class="mt-4 space-y-3">
                {(aboutData?.achievements ?? [
                  'Diplômée restaurateur-traiteur (mai 2024)',
                  "Auteur d'un livre de recettes",
                  'Spécialiste cuisine santé et bien-être'
                ]).map((achievement, index) => (
                  <div class="flex items-start gap-3" key={index}>
                    <span class="mt-1 inline-flex h-2.5 w-2.5 rounded-full bg-mv-leaf"></span>
                    <p class="text-sm sm:text-base text-mv-forest-80 leading-snug">{achievement}</p>
                  </div>
                ))}
              </div>
              <a href={aboutCtaLink} class="mv-btn mv-btn-secondary border-mv-forest text-mv-forest hover:bg-mv-forest hover:text-mv-cream mt-6 inline-flex">
                {aboutCtaLabel}
              </a>
            </div>
          )}
        </div>
      </div>
    </Section>
  )}

  {showJourney && (
    <Section class="bg-white" containerClass="max-w-5xl">
      <div class="max-w-3xl" slot="content">
        <p class="mv-kicker">Parcours</p>
        <h2 class="mv-section-title">
          {aboutData?.journeyTitle ?? 'Mon parcours'}
        </h2>
        <p class="mv-lead text-mv-forest-70">
          {aboutData?.journeyIntro ?? 'Après une licence en Affaires Publiques et Internationales (UCL), c’est la passion pour l’alimentation qui m’a guidé pour la suite.'}
        </p>
      </div>

      <div class="mt-6 rounded-3xl border border-mv-leaf-20 bg-mv-cream-50 p-6 sm:p-8" slot="content">
        <ol class="relative space-y-6 border-l border-mv-leaf-30 pl-6">
          {journeyItems.map((item, index) => (
            <li class="relative pl-4" key={index}>
              <span class="absolute -left-[34px] top-0 flex h-8 w-8 items-center justify-center rounded-full bg-mv-leaf text-mv-cream text-xs font-semibold">
                {String(index + 1).padStart(2, '0')}
              </span>
              <p class="text-base sm:text-lg text-mv-forest-80 leading-relaxed">{item}</p>
            </li>
          ))}
        </ol>
      </div>
    </Section>
  )}

  {showSignature && (
    <Section class="bg-mv-cream" containerClass="max-w-5xl">
      <div class="max-w-3xl" slot="content">
        <p class="mv-kicker">Fil rouge</p>
        <h2 class="mv-section-title">
          {aboutData?.signatureTitle ?? 'Fil rouge de mes recettes'}
        </h2>
      </div>
      {aboutParagraphs.length > 0 && (
        <div class="mt-5 rounded-3xl border border-mv-leaf-20 bg-mv-cream-50 p-6 sm:p-8" slot="content">
          <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-60">Ma cuisine au quotidien</p>
          <div class="mt-4 space-y-4 text-base sm:text-lg text-mv-forest-80 leading-relaxed">
            {aboutParagraphs.map((paragraph, index) => (
              <p key={index}>{paragraph}</p>
            ))}
          </div>
        </div>
      )}
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" slot="content">
        {signatureParagraphs.map((paragraph, index) => {
          const isLast = index === signatureParagraphs.length - 1;
          return (
            <div class={`mv-card p-5 sm:p-6 ${isLast ? 'md:col-span-2' : ''}`} key={index}>
              <p class="text-xs uppercase tracking-[0.2em] text-mv-forest-60">Essentiel {String(index + 1).padStart(2, '0')}</p>
              <p class="mt-3 text-base sm:text-lg text-mv-forest-80 leading-relaxed">{paragraph}</p>
            </div>
          );
        })}
      </div>
    </Section>
  )}

  <!-- Services Section -->
  {showServices && (
    <Section id="services" class="bg-mv-cream">
      <div class="text-center mb-6 sm:mb-8 lg:mb-10" slot="content">
        <h2 class="mv-section-title mb-3 sm:mb-4">
          {aboutData?.servicesTitle || 'Mes Services'}
        </h2>
        <p class="text-base sm:text-lg text-mv-forest-70 max-w-2xl mx-auto leading-relaxed">
          {aboutData?.servicesSubtitle || 'Cours de cuisine à la carte et coaching personnalisé pour votre bien-être alimentaire'}
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 lg:gap-8" slot="content">
        {aboutData?.services ? aboutData.services.map((service, index) => (
          <PricingCard
            title={service.title}
            subtitle={service.description}
            price={service.price}
            period=""
            features={service.features}
            priority={String(index + 1)}
            ctaText={aboutData?.servicesCtaText || "En savoir plus"}
            ctaLink={aboutData?.servicesCtaLink || "/contact"}
          />
        )) : (
          <>
            <PricingCard
              title="Balade"
              subtitle="Découverte culinaire"
              price="125€"
              period=""
            features={[
              "Balade gourmande dans la nature",
              "Découverte des produits locaux",
              "Atelier de cueillette",
              "Préparation d'un pique-nique sain",
              "Moment de partage et de convivialité"
            ]}
            priority="1"
            ctaText="Réserver une balade"
            ctaLink="/contact"
          />

          <PricingCard
            title="Conférence"
            subtitle="Nutrition & Bien-être"
            price="250€"
            period=""
            features={[
              "Conférence sur l'alimentation santé",
              "Conseils nutritionnels personnalisés",
              "Échanges avec le public",
              "Support pédagogique",
              "Durée: 1h30"
            ]}
            priority="2"
            ctaText="Organiser une conférence"
            ctaLink="/contact"
          />

          <PricingCard
            title="Ateliers"
            subtitle="Cuisine interactive"
            price="65€"
            period="/pers."
            features={[
              "Atelier cuisine pratique",
              "Préparation de recettes saines",
              "Apprentissage des techniques",
              "Dégustation des préparations",
              "Groupe de 4 à 8 personnes"
            ]}
            priority="3"
            ctaText="S'inscrire à un atelier"
            ctaLink="/contact"
          />
        </>
      )}
    </div>
  </Section>
  )}

</MainLayout>
