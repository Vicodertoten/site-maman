---
// NewsletterSignup.astro - Composant d'inscription à la newsletter
---

<div id="newsletter-signup" class="bg-mv-cream rounded-lg p-6 my-8 border border-mv-leaf/20">
  <div class="text-center">
    <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
      Restez informé(e)
    </h3>
    <p class="text-mv-forest/80 mb-4">
      Recevez mes dernières recettes et conseils nutritionnels directement dans votre boîte mail.
    </p>

    <form id="newsletter-form" name="newsletter" method="POST" data-netlify="true" action="/merci" class="max-w-md mx-auto">
      <!-- Champ caché requis par Netlify Forms -->
      <input type="hidden" name="form-name" value="newsletter" />
      <div class="flex gap-2">
        <input
          type="email"
          name="email"
          id="newsletter-email"
          placeholder="Votre adresse email"
          class="flex-1 px-4 py-2 border border-mv-leaf/30 rounded-lg focus:ring-2 focus:ring-mv-leaf focus:border-mv-leaf bg-white"
          required
        />
        <button
          type="submit"
          id="newsletter-submit"
          class="bg-mv-leaf text-mv-cream px-6 py-2 mv-pill hover:bg-mv-forest hover:scale-105 transition-all duration-300 transform font-medium shadow-sm hover:shadow-md"
        >
          S'inscrire
        </button>
      </div>
      <p id="newsletter-message" class="text-sm mt-2 opacity-0 transition-opacity"></p>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('newsletter-form') as HTMLFormElement;
    const submitButton = document.getElementById('newsletter-submit') as HTMLButtonElement;
    const messageElement = document.getElementById('newsletter-message') as HTMLParagraphElement;

    const showMessage = (message: string, isError: boolean = false) => {
      messageElement.textContent = message;
      messageElement.className = `text-sm mt-2 transition-opacity ${isError ? 'text-red-600' : 'text-green-600'}`;
      messageElement.style.opacity = '1';

      setTimeout(() => {
        messageElement.style.opacity = '0';
      }, 5000);
    };

    const setLoading = (loading: boolean) => {
      submitButton.disabled = loading;
      submitButton.textContent = loading ? 'Inscription...' : 'S\'inscrire';
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);

      try {
        // Utiliser l'API Fetch pour soumettre à Netlify Forms
        const formData = new FormData(form);
        const response = await fetch('/', {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          showMessage('Inscription réussie ! Merci de votre intérêt.');
          form.reset();
        } else {
          throw new Error('Erreur lors de l\'inscription');
        }
      } catch (error) {
        console.error('Erreur:', error);
        showMessage('Erreur lors de l\'inscription. Veuillez réessayer.', true);
      } finally {
        setLoading(false);
      }
    });
  });
</script>