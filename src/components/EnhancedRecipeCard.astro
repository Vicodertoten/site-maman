---
// EnhancedRecipeCard.astro - Carte de recette avec hiÃ©rarchie visuelle amÃ©liorÃ©e
export interface Props {
  recipe: {
    id: string;
    slug?: string; // Ajouter le slug
    title: string;
    description?: string;
    image?: string;
    imageAlt?: string;
    prepTime?: number;
    cookTime?: number;
    restTime?: number;
    servings?: number;
    difficulty?: 'facile' | 'moyen' | 'difficile';
    category?: string;
    categoryValue?: string;
    rating?: number;
    isNew?: boolean;
    isPopular?: boolean;
    tags?: string[];
    ingredients?: string[];
    publishedAt?: string;
  };
  showFavoriteButton?: boolean;
  showShoppingListButton?: boolean;
  compact?: boolean;
}

const {
  recipe,
  showFavoriteButton = true,
  showShoppingListButton = true,
  compact = false
} = Astro.props;

// Fonctions utilitaires
const formatTime = (minutes: number) => {
  if (!minutes || minutes <= 0) return '';
  const rounded = Math.round(minutes);
  if (rounded < 60) {
    return `${rounded} min`;
  }
  const hours = Math.floor(rounded / 60);
  const mins = rounded % 60;
  return mins > 0 ? `${hours}h ${mins.toString().padStart(2, '0')} min` : `${hours}h`;
};

const getTotalTime = (prep?: number, cook?: number, rest?: number) => {
  const total = (prep || 0) + (cook || 0) + (rest || 0);
  return total > 0 ? total : undefined;
};

const getDifficultyColor = (difficulty: string) => {
  switch (difficulty) {
    case 'facile': return 'text-mv-leaf bg-mv-leaf-20 border border-mv-leaf-30';
    case 'moyen': return 'text-mv-coral bg-mv-coral-20 border border-mv-coral-30';
    case 'difficile': return 'text-mv-coral bg-mv-coral-30 border border-mv-coral-50';
    default: return 'text-mv-forest bg-mv-cream border border-mv-leaf-30';
  }
};

const getDifficultyIcon = (difficulty: string) => {
  switch (difficulty) {
    case 'facile': return 'ðŸŸ¢';
    case 'moyen': return 'ðŸŸ¡';
    case 'difficile': return 'ðŸ”´';
    default: return 'âšª';
  }
};
---

<article
  class={`enhanced-recipe-card group relative mv-card hover:border-mv-leaf transition-all duration-300 overflow-hidden ${compact ? 'p-4' : 'p-6'}`}
  data-recipe-id={recipe.id}
  data-recipe-slug={recipe.slug}
  data-recipe-title={recipe.title}
  data-recipe-category={recipe.categoryValue || recipe.category}
  data-recipe-difficulty={recipe.difficulty}
  data-recipe-tags={recipe.tags?.join(',')}
  data-recipe-ingredients={recipe.ingredients?.join(',')}
>
  <a
    href={`/recette/${encodeURIComponent(recipe.slug || recipe.id)}`}
    class="absolute inset-0 z-10 rounded-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mv-leaf focus-visible:ring-offset-2"
    aria-label={`Voir la recette ${recipe.title}`}
  >
    <span class="sr-only">Voir la recette {recipe.title}</span>
  </a>

  <!-- Badge Nouveau/Populaire -->
  <div class="absolute top-3 left-3 z-20 flex gap-2 pointer-events-none">
    {recipe.isNew && (
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-mv-coral text-mv-cream animate-pulse">
        Nouveau
      </span>
    )}
    {recipe.isPopular && (
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-mv-plum text-mv-cream">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
        </svg>
        Populaire
      </span>
    )}
  </div>

  <!-- Boutons d'action -->
  <div class="absolute top-3 right-3 z-20 flex gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-300">
    {showFavoriteButton && (
      <button
        class="favorite-btn w-8 h-8 bg-white rounded-full shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center hover:scale-110"
        data-recipe-id={recipe.id}
        data-recipe-title={recipe.title}
        aria-label="Ajouter aux favoris"
      >
        <svg class="favorite-icon w-4 h-4 text-mv-forest-60 hover:text-mv-coral transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <span class="favorite-text sr-only">Ajouter aux favoris</span>
      </button>
    )}

    {showShoppingListButton && (
      <button
        class="shopping-btn w-8 h-8 bg-white rounded-full shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center hover:scale-110"
        data-recipe-id={recipe.id}
        data-recipe-title={recipe.title}
        aria-label="Ajouter Ã  la liste de courses"
      >
        <svg class="w-4 h-4 text-mv-forest-60 hover:text-mv-leaf transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
      </button>
    )}
  </div>

  <!-- Image -->
  <div class={`relative z-20 overflow-hidden rounded-lg pointer-events-none ${compact ? 'mb-3' : 'mb-4'}`}>
    {recipe.image ? (
      <img
        src={recipe.image}
        alt={recipe.imageAlt || recipe.title}
        class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
        loading="lazy"
        decoding="async"
        width="400"
        height="300"
        sizes="(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
      />
    ) : (
      <div class="w-full h-48 bg-gradient-to-br from-mv-cream to-mv-leaf flex items-center justify-center">
        <svg class="w-12 h-12 text-mv-forest opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
    )}

    <!-- Overlay de chargement -->
    <div class="image-loading-overlay absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center opacity-0 transition-opacity duration-300">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-mv-leaf"></div>
    </div>
  </div>

  <!-- Contenu -->
  <div class="relative z-20 space-y-3 pointer-events-none">
    <!-- Titre et catÃ©gorie -->
    <div>
      <div class="flex items-start justify-between mb-1">
        <h3 class="text-lg font-semibold text-mv-forest group-hover:text-mv-leaf transition-colors duration-200 line-clamp-2">
          {recipe.title}
        </h3>
        {recipe.category && (
          <span class="text-xs font-medium text-mv-forest bg-mv-cream px-2 py-1 rounded-full ml-2 flex-shrink-0">
            {recipe.category}
          </span>
        )}
      </div>

      {recipe.description && (
        <p class="text-sm text-mv-forest-80 line-clamp-2">
          {recipe.description}
        </p>
      )}
    </div>

    <!-- MÃ©tadonnÃ©es -->
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center space-x-4">
        <!-- Temps de prÃ©paration -->
        {getTotalTime(recipe.prepTime, recipe.cookTime, recipe.restTime) && (
          <div class="flex items-center text-mv-forest-70">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            {formatTime(getTotalTime(recipe.prepTime, recipe.cookTime, recipe.restTime) as number)}
          </div>
        )}

        {recipe.servings && (
          <div class="flex items-center text-mv-forest-70">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M9 20H4v-2a3 3 0 015.356-1.857m0 0a5 5 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            {recipe.servings} pers.
          </div>
        )}

        <!-- DifficultÃ© -->
        {recipe.difficulty && (
          <div class={`flex items-center px-2 py-1 rounded-full text-xs font-medium ${getDifficultyColor(recipe.difficulty)}`}>
            <span class="mr-1">{getDifficultyIcon(recipe.difficulty)}</span>
            {recipe.difficulty}
          </div>
        )}
      </div>
    </div>

    <!-- Tags retirÃ©s pour allÃ©ger la carte -->
  </div>

  <!-- Micro-interactions -->
  <div class="absolute inset-0 rounded-xl border-2 border-transparent group-hover:border-mv-leaf group-hover:border-opacity-20 transition-all duration-300 pointer-events-none"></div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .enhanced-recipe-card {
    transform: translateY(0);
  }

  .enhanced-recipe-card:hover {
    transform: translateY(-2px);
  }

  /* Animation d'entrÃ©e */
  .enhanced-recipe-card {
    animation: fadeInScale 0.4s ease-out forwards;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Ã‰tats des boutons favoris */
  .favorite-btn.favorited .favorite-icon {
    fill: currentColor;
    color: var(--mv-coral);
  }

  .shopping-btn.active svg {
    color: var(--mv-leaf);
  }

  /* Responsive */
  @media (max-width: 640px) {
    .enhanced-recipe-card {
      margin-bottom: 1rem;
    }

    .enhanced-recipe-card .group:hover .opacity-0 {
      opacity: 1;
    }
  }

  /* AccessibilitÃ© */
  @media (prefers-reduced-motion: reduce) {
    .enhanced-recipe-card,
    .enhanced-recipe-card:hover,
    .favorite-btn,
    .shopping-btn,
    .image-loading-overlay {
      animation: none;
      transition: none;
      transform: none;
    }
  }
</style>

<script>
  class EnhancedRecipeCard {
    constructor(cardElement) {
      this.card = cardElement;
      this.recipeId = this.card.dataset.recipeId || this.card.querySelector('[data-recipe-id]')?.dataset.recipeId;
      this.card.enhancedRecipeCard = this;
      this.init();
    }

    init() {
      this.bindEvents();
    }

    bindEvents() {
      // Bouton favoris
      const favoriteBtn = this.card.querySelector('.favorite-btn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      }

      // Bouton liste de courses
      const shoppingBtn = this.card.querySelector('.shopping-btn');
      if (shoppingBtn) {
        shoppingBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.addToShoppingList();
        });
      }

      // Gestion du chargement d'image
      const img = this.card.querySelector('img');
      if (img) {
        const overlay = this.card.querySelector('.image-loading-overlay');
        img.addEventListener('load', () => {
          overlay.style.opacity = '0';
        });
        img.addEventListener('error', () => {
          overlay.innerHTML = `
            <svg class="w-8 h-8 text-mv-forest-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          `;
          overlay.style.opacity = '1';
        });
      }
    }

    addToShoppingList() {
      // DÃ©clencher l'Ã©vÃ©nement pour ouvrir le panneau de liste de courses
      window.dispatchEvent(new CustomEvent('addToShoppingList', {
        detail: { recipeId: this.recipeId, recipeTitle: this.card.dataset.recipeTitle }
      }));

      // Animation de feedback
      const btn = this.card.querySelector('.shopping-btn');
      btn.style.transform = 'scale(1.2)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 150);
    }

  }

  // Initialiser toutes les cartes de recettes
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.enhanced-recipe-card').forEach(card => {
      new EnhancedRecipeCard(card);
    });
  });

  // RÃ©initialiser les cartes aprÃ¨s un filtrage
  window.addEventListener('recipesFiltered', () => {
    setTimeout(() => {
      document.querySelectorAll('.enhanced-recipe-card').forEach(card => {
        if (!card.enhancedRecipeCard) {
          card.enhancedRecipeCard = new EnhancedRecipeCard(card);
        }
      });
    }, 100);
  });
</script>
