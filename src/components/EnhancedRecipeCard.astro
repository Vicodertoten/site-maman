---
// EnhancedRecipeCard.astro - Carte de recette avec hiÃ©rarchie visuelle amÃ©liorÃ©e
export interface Props {
  recipe: {
    id: string;
    slug?: string; // Ajouter le slug
    title: string;
    description?: string;
    image?: string;
    prepTime?: number;
    cookTime?: number;
    difficulty?: 'facile' | 'moyen' | 'difficile';
    category?: string;
    rating?: number;
    isNew?: boolean;
    isPopular?: boolean;
    tags?: string[];
  };
  showFavoriteButton?: boolean;
  showShoppingListButton?: boolean;
  compact?: boolean;
}

const {
  recipe,
  showFavoriteButton = true,
  showShoppingListButton = true,
  compact = false
} = Astro.props;

// Fonctions utilitaires
const formatTime = (minutes: number) => {
  if (minutes < 60) return `${minutes}min`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours}h${mins}min` : `${hours}h`;
};

const getDifficultyColor = (difficulty: string) => {
  switch (difficulty) {
    case 'facile': return 'text-mv-leaf bg-mv-leaf-20 border border-mv-leaf-30';
    case 'moyen': return 'text-mv-coral bg-mv-coral-20 border border-mv-coral-30';
    case 'difficile': return 'text-mv-coral bg-mv-coral-30 border border-mv-coral-50';
    default: return 'text-mv-forest bg-mv-cream border border-mv-leaf-30';
  }
};

const getDifficultyIcon = (difficulty: string) => {
  switch (difficulty) {
    case 'facile': return 'ðŸŸ¢';
    case 'moyen': return 'ðŸŸ¡';
    case 'difficile': return 'ðŸ”´';
    default: return 'âšª';
  }
};
---

<article class={`enhanced-recipe-card group relative bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden border border-gray-200 hover:border-mv-leaf ${compact ? 'p-4' : 'p-6'}`} data-recipe-id={recipe.id} data-recipe-slug={recipe.slug} data-recipe-title={recipe.title} data-recipe-category={recipe.category} data-recipe-difficulty={recipe.difficulty} data-recipe-tags={recipe.tags?.join(',')} data-recipe-ingredients={recipe.ingredients?.join(',')}>
  <!-- Badge Nouveau/Populaire -->
  <div class="absolute top-3 left-3 z-10 flex gap-2">
    {recipe.isNew && (
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-mv-coral text-white animate-pulse">
        Nouveau
      </span>
    )}
    {recipe.isPopular && (
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-mv-plum text-white">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
        </svg>
        Populaire
      </span>
    )}
  </div>

  <!-- Boutons d'action -->
  <div class="absolute top-3 right-3 z-10 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
    {showFavoriteButton && (
      <button
        class="favorite-btn w-8 h-8 bg-white rounded-full shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center hover:scale-110"
        data-recipe-id={recipe.id}
        aria-label="Ajouter aux favoris"
      >
        <svg class="w-4 h-4 text-mv-forest-60 hover:text-mv-coral transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
      </button>
    )}

    {showShoppingListButton && (
      <button
        class="shopping-btn w-8 h-8 bg-white rounded-full shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center hover:scale-110"
        data-recipe-id={recipe.id}
        aria-label="Ajouter Ã  la liste de courses"
      >
        <svg class="w-4 h-4 text-gray-400 hover:text-mv-leaf transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
      </button>
    )}
  </div>

  <!-- Image -->
  <div class={`relative overflow-hidden rounded-lg ${compact ? 'mb-3' : 'mb-4'}`}>
    {recipe.image ? (
      <img
        src={recipe.image}
        alt={recipe.title}
        class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
        loading="lazy"
      />
    ) : (
      <div class="w-full h-48 bg-gradient-to-br from-mv-cream to-mv-leaf flex items-center justify-center">
        <svg class="w-12 h-12 text-mv-forest opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
    )}

    <!-- Overlay de chargement -->
    <div class="image-loading-overlay absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center opacity-0 transition-opacity duration-300">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-mv-leaf"></div>
    </div>
  </div>

  <!-- Contenu -->
  <div class="space-y-3">
    <!-- Titre et catÃ©gorie -->
    <div>
      <div class="flex items-start justify-between mb-1">
        <h3 class="text-lg font-semibold text-mv-forest group-hover:text-mv-leaf transition-colors duration-200 line-clamp-2">
          {recipe.title}
        </h3>
        {recipe.category && (
          <span class="text-xs font-medium text-mv-forest bg-mv-cream px-2 py-1 rounded-full ml-2 flex-shrink-0">
            {recipe.category}
          </span>
        )}
      </div>

      {recipe.description && (
        <p class="text-sm text-mv-forest-80 line-clamp-2">
          {recipe.description}
        </p>
      )}
    </div>

    <!-- MÃ©tadonnÃ©es -->
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center space-x-4">
        <!-- Temps de prÃ©paration -->
        {(recipe.prepTime || recipe.cookTime) && (
          <div class="flex items-center text-mv-forest-70">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            {recipe.prepTime && recipe.cookTime ?
              `${formatTime(recipe.prepTime + recipe.cookTime)}` :
              recipe.prepTime ?
                `Prep: ${formatTime(recipe.prepTime)}` :
                `Cuisson: ${formatTime(recipe.cookTime)}`
            }
          </div>
        )}

        <!-- DifficultÃ© -->
        {recipe.difficulty && (
          <div class={`flex items-center px-2 py-1 rounded-full text-xs font-medium ${getDifficultyColor(recipe.difficulty)}`}>
            <span class="mr-1">{getDifficultyIcon(recipe.difficulty)}</span>
            {recipe.difficulty}
          </div>
        )}
      </div>

      <!-- Note -->
      {recipe.rating && (
        <div class="flex items-center text-mv-coral">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          <span class="text-sm font-medium text-mv-forest">{recipe.rating.toFixed(1)}</span>
        </div>
      )}
    </div>

    <!-- Tags -->
    {recipe.tags && recipe.tags.length > 0 && (
      <div class="flex flex-wrap gap-1">
        {recipe.tags.slice(0, 3).map(tag => (
          <span class="inline-block px-2 py-1 text-xs bg-mv-cream text-mv-forest rounded-full">
            #{tag}
          </span>
        ))}
        {recipe.tags.length > 3 && (
          <span class="inline-block px-2 py-1 text-xs bg-mv-cream text-mv-forest-70 rounded-full">
            +{recipe.tags.length - 3}
          </span>
        )}
      </div>
    )}
  </div>

  <!-- Micro-interactions -->
  <div class="absolute inset-0 rounded-xl border-2 border-transparent group-hover:border-mv-leaf group-hover:border-opacity-20 transition-all duration-300 pointer-events-none"></div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .enhanced-recipe-card {
    transform: translateY(0);
  }

  .enhanced-recipe-card:hover {
    transform: translateY(-2px);
  }

  /* Animation d'entrÃ©e */
  .enhanced-recipe-card {
    animation: fadeInScale 0.4s ease-out forwards;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Ã‰tats des boutons favoris */
  .favorite-btn.active svg {
    fill: currentColor;
    color: #ef4444;
  }

  .shopping-btn.active svg {
    color: #16a34a;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .enhanced-recipe-card {
      margin-bottom: 1rem;
    }

    .enhanced-recipe-card .group:hover .opacity-0 {
      opacity: 1;
    }
  }

  /* AccessibilitÃ© */
  @media (prefers-reduced-motion: reduce) {
    .enhanced-recipe-card,
    .enhanced-recipe-card:hover,
    .favorite-btn,
    .shopping-btn,
    .image-loading-overlay {
      animation: none;
      transition: none;
      transform: none;
    }
  }
</style>

<script>
  class EnhancedRecipeCard {
    constructor(cardElement) {
      this.card = cardElement;
      this.recipeId = this.card.querySelector('[data-recipe-id]')?.dataset.recipeId;
      this.recipeSlug = this.card.dataset.recipeSlug || this.recipeId; // Utiliser le slug ou l'ID comme fallback
      this.init();
    }

    init() {
      this.bindEvents();
      this.loadStates();
    }

    bindEvents() {
      // Bouton favoris
      const favoriteBtn = this.card.querySelector('.favorite-btn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.toggleFavorite();
        });
      }

      // Bouton liste de courses
      const shoppingBtn = this.card.querySelector('.shopping-btn');
      if (shoppingBtn) {
        shoppingBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.addToShoppingList();
        });
      }

      // Clic sur la carte
      this.card.addEventListener('click', () => {
        this.navigateToRecipe();
      });

      // Gestion du chargement d'image
      const img = this.card.querySelector('img');
      if (img) {
        const overlay = this.card.querySelector('.image-loading-overlay');
        img.addEventListener('load', () => {
          overlay.style.opacity = '0';
        });
        img.addEventListener('error', () => {
          overlay.innerHTML = `
            <svg class="w-8 h-8 text-mv-forest-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          `;
          overlay.style.opacity = '1';
        });
      }
    }

    toggleFavorite() {
      const btn = this.card.querySelector('.favorite-btn');
      const isActive = btn.classList.contains('active');

      if (isActive) {
        this.removeFromFavorites();
        btn.classList.remove('active');
      } else {
        this.addToFavorites();
        btn.classList.add('active');
      }

      // Animation de feedback
      btn.style.transform = 'scale(1.2)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 150);
    }

    addToFavorites() {
      const favorites = JSON.parse(localStorage.getItem('recipeFavorites') || '[]');
      if (!favorites.includes(this.recipeId)) {
        favorites.push(this.recipeId);
        localStorage.setItem('recipeFavorites', JSON.stringify(favorites));
      }

      // Notification
      this.showNotification('Recette ajoutÃ©e aux favoris !', 'success');
    }

    removeFromFavorites() {
      const favorites = JSON.parse(localStorage.getItem('recipeFavorites') || '[]');
      const index = favorites.indexOf(this.recipeId);
      if (index > -1) {
        favorites.splice(index, 1);
        localStorage.setItem('recipeFavorites', JSON.stringify(favorites));
      }

      // Notification
      this.showNotification('Recette retirÃ©e des favoris', 'info');
    }

    addToShoppingList() {
      // DÃ©clencher l'Ã©vÃ©nement pour ouvrir le panneau de liste de courses
      window.dispatchEvent(new CustomEvent('addToShoppingList', {
        detail: { recipeId: this.recipeId }
      }));

      // Animation de feedback
      const btn = this.card.querySelector('.shopping-btn');
      btn.style.transform = 'scale(1.2)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 150);

      this.showNotification('IngrÃ©dients ajoutÃ©s Ã  la liste !', 'success');
    }

    navigateToRecipe() {
      // Navigation vers la page de la recette en utilisant le slug
      window.location.href = `/recette/${this.recipeSlug}`;
    }

    loadStates() {
      // Charger l'Ã©tat des favoris
      const favorites = JSON.parse(localStorage.getItem('recipeFavorites') || '[]');
      if (favorites.includes(this.recipeId)) {
        this.card.querySelector('.favorite-btn')?.classList.add('active');
      }
    }

    showNotification(message, type = 'info') {
      // CrÃ©er une notification temporaire
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg transform translate-x-full transition-transform duration-300 ${
        type === 'success' ? 'bg-mv-leaf' : 'bg-mv-forest'
      }`;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Animation d'entrÃ©e
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);

      // Supprimer aprÃ¨s 3 secondes
      setTimeout(() => {
        notification.style.transform = 'translateX(full)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
  }

  // Initialiser toutes les cartes de recettes
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.enhanced-recipe-card').forEach(card => {
      new EnhancedRecipeCard(card);
    });
  });

  // RÃ©initialiser les cartes aprÃ¨s un filtrage
  window.addEventListener('recipesFiltered', () => {
    setTimeout(() => {
      document.querySelectorAll('.enhanced-recipe-card').forEach(card => {
        if (!card.enhancedRecipeCard) {
          card.enhancedRecipeCard = new EnhancedRecipeCard(card);
        }
      });
    }, 100);
  });
</script>