---
// AdvancedSearch.astro - Recherche avancée avec suggestions
export interface Props {
  placeholder?: string;
  showSuggestions?: boolean;
  maxSuggestions?: number;
}

const { placeholder = "Rechercher des recettes...", showSuggestions = true, maxSuggestions = 5 } = Astro.props;
---

<div class="advanced-search relative">
  <div class="search-input-container">
    <div class="relative">
      <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <input
        type="text"
        id="advanced-search-input"
        placeholder={placeholder}
        autocomplete="off"
        class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-mv-leaf focus:border-transparent transition-all duration-200 bg-white"
        aria-label="Recherche avancée"
      />
      <button
        id="search-submit"
        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-mv-leaf hover:text-mv-forest transition-colors"
        aria-label="Lancer la recherche"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Suggestions -->
  <div id="search-suggestions" class="search-suggestions absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-50 mt-1 hidden">
    <div class="max-h-64 overflow-y-auto">
      <div id="suggestions-list" class="py-2">
        <!-- Les suggestions seront ajoutées dynamiquement -->
      </div>
    </div>
    <div class="border-t border-mv-leaf-20 px-4 py-2 text-xs text-mv-forest-70 bg-mv-cream">
      <span id="suggestions-count">0</span> suggestion(s) trouvée(s)
    </div>
  </div>

  <!-- Filtres de recherche rapide -->
  <div class="search-filters mt-4 flex flex-wrap gap-2">
    <button class="search-filter-btn px-3 py-1 bg-mv-cream text-mv-forest rounded-full text-sm hover:bg-mv-leaf hover:text-mv-cream transition-colors" data-filter="title">
      Dans les titres
    </button>
    <button class="search-filter-btn px-3 py-1 bg-mv-cream text-mv-forest rounded-full text-sm hover:bg-mv-leaf hover:text-mv-cream transition-colors" data-filter="ingredients">
      Dans les ingrédients
    </button>
    <button class="search-filter-btn px-3 py-1 bg-mv-cream text-mv-forest rounded-full text-sm hover:bg-mv-leaf hover:text-mv-cream transition-colors" data-filter="description">
      Dans les descriptions
    </button>
    <button class="search-filter-btn px-3 py-1 bg-mv-cream text-mv-forest rounded-full text-sm hover:bg-mv-leaf hover:text-mv-cream transition-colors" data-filter="all">
      Partout
    </button>
  </div>
</div>

<script>
  class AdvancedSearch {
    constructor() {
      this.searchInput = document.getElementById('advanced-search-input');
      this.suggestionsContainer = document.getElementById('search-suggestions');
      this.suggestionsList = document.getElementById('suggestions-list');
      this.suggestionsCount = document.getElementById('suggestions-count');
      this.searchSubmit = document.getElementById('search-submit');

      this.recipes = [];
      this.currentFilter = 'all';
      this.selectedIndex = -1;
      this.isLoading = false;

      this.init();
    }

    init() {
      this.bindEvents();
      this.loadRecipes();
    }

    bindEvents() {
      // Recherche en temps réel
      this.searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          this.debouncedSearch(query);
        } else {
          this.hideSuggestions();
        }
      });

      // Navigation au clavier
      this.searchInput.addEventListener('keydown', (e) => {
        if (!this.suggestionsContainer.classList.contains('hidden')) {
          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              this.navigateSuggestions(1);
              break;
            case 'ArrowUp':
              e.preventDefault();
              this.navigateSuggestions(-1);
              break;
            case 'Enter':
              e.preventDefault();
              this.selectSuggestion();
              break;
            case 'Escape':
              this.hideSuggestions();
              break;
          }
        }
      });

      // Clic sur le bouton de recherche
      this.searchSubmit.addEventListener('click', () => {
        this.performSearch();
      });

      // Clic en dehors pour fermer les suggestions
      document.addEventListener('click', (e) => {
        if (!this.searchInput.contains(e.target) && !this.suggestionsContainer.contains(e.target)) {
          this.hideSuggestions();
        }
      });

      // Filtres de recherche
      document.querySelectorAll('.search-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          this.setSearchFilter(btn.dataset.filter);
        });
      });
    }

    debouncedSearch(query) {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(() => {
        this.search(query);
      }, 200);
    }

    async loadRecipes() {
      try {
        // Charger les recettes depuis Sanity ou une API
        // Pour l'instant, on utilise des données fictives
        this.recipes = [
          { id: 1, title: 'Salade César', ingredients: ['laitue', 'poulet', 'parmesan'], description: 'Une salade classique' },
          { id: 2, title: 'Pâtes Carbonara', ingredients: ['pâtes', 'œufs', 'lardons'], description: 'Pâtes crémeuses' },
          { id: 3, title: 'Tarte aux pommes', ingredients: ['pommes', 'pâte', 'sucre'], description: 'Dessert traditionnel' },
          // Ajouter plus de recettes...
        ];
      } catch (error) {
        console.error('Erreur lors du chargement des recettes:', error);
      }
    }

    search(query) {
      if (query.length < 2) {
        this.hideSuggestions();
        return;
      }

      const suggestions = this.getSuggestions(query);
      this.showSuggestions(suggestions);
    }

    getSuggestions(query) {
      const queryLower = query.toLowerCase();
      const suggestions = [];

      this.recipes.forEach(recipe => {
        let score = 0;
        let matchType = '';

        // Recherche dans le titre (priorité haute)
        if (recipe.title.toLowerCase().includes(queryLower)) {
          score += 10;
          matchType = 'title';
        }

        // Recherche dans les ingrédients
        if (this.currentFilter === 'all' || this.currentFilter === 'ingredients') {
          const matchingIngredients = recipe.ingredients.filter(ing =>
            ing.toLowerCase().includes(queryLower)
          );
          if (matchingIngredients.length > 0) {
            score += 5 * matchingIngredients.length;
            matchType = matchType || 'ingredients';
          }
        }

        // Recherche dans la description
        if (this.currentFilter === 'all' || this.currentFilter === 'description') {
          if (recipe.description.toLowerCase().includes(queryLower)) {
            score += 3;
            matchType = matchType || 'description';
          }
        }

        if (score > 0) {
          suggestions.push({
            ...recipe,
            score,
            matchType,
            highlightedTitle: this.highlightMatch(recipe.title, query),
            highlightedIngredients: recipe.ingredients.map(ing =>
              this.highlightMatch(ing, query)
            )
          });
        }
      });

      // Trier par score décroissant
      return suggestions
        .sort((a, b) => b.score - a.score)
        .slice(0, 5); // Limiter à 5 suggestions
    }

    highlightMatch(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark class="bg-mv-leaf bg-opacity-20">$1</mark>');
    }

    showSuggestions(suggestions) {
      if (suggestions.length === 0) {
        this.hideSuggestions();
        return;
      }

      this.suggestionsList.innerHTML = suggestions.map((suggestion, index) => `
        <div class="suggestion-item px-4 py-3 hover:bg-mv-cream-50 cursor-pointer border-b border-mv-leaf-20 last:border-b-0" data-index="${index}" data-recipe-id="${suggestion.id}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="font-medium text-mv-forest" dangerouslySetInnerHTML={{ __html: suggestion.highlightedTitle }}></div>
              <div class="text-sm text-mv-forest-80 mt-1">
                Ingrédients: ${suggestion.highlightedIngredients.join(', ')}
              </div>
              <div class="text-xs text-mv-forest-70 mt-1">${suggestion.description}</div>
            </div>
            <div class="ml-3 text-xs text-gray-400 capitalize">${suggestion.matchType}</div>
          </div>
        </div>
      `).join('');

      this.suggestionsCount.textContent = suggestions.length;
      this.suggestionsContainer.classList.remove('hidden');
      this.selectedIndex = -1;

      // Attacher les événements aux suggestions
      this.bindSuggestionEvents();
    }

    hideSuggestions() {
      this.suggestionsContainer.classList.add('hidden');
      this.selectedIndex = -1;
    }

    bindSuggestionEvents() {
      document.querySelectorAll('.suggestion-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          this.selectSuggestion(index);
        });

        item.addEventListener('mouseenter', () => {
          this.selectedIndex = index;
          this.updateSelection();
        });
      });
    }

    navigateSuggestions(direction) {
      const items = document.querySelectorAll('.suggestion-item');
      if (items.length === 0) return;

      this.selectedIndex += direction;

      if (this.selectedIndex < 0) {
        this.selectedIndex = items.length - 1;
      } else if (this.selectedIndex >= items.length) {
        this.selectedIndex = 0;
      }

      this.updateSelection();
    }

    updateSelection() {
      document.querySelectorAll('.suggestion-item').forEach((item, index) => {
        if (index === this.selectedIndex) {
          item.classList.add('bg-mv-cream', 'bg-opacity-50');
        } else {
          item.classList.remove('bg-mv-cream', 'bg-opacity-50');
        }
      });
    }

    selectSuggestion(index = this.selectedIndex) {
      if (index === -1) return;

      const item = document.querySelectorAll('.suggestion-item')[index];
      if (item) {
        const recipeId = item.dataset.recipeId;
        // Rediriger vers la recette ou déclencher un événement
        window.dispatchEvent(new CustomEvent('recipeSelected', {
          detail: { recipeId: parseInt(recipeId) }
        }));

        this.hideSuggestions();
        this.searchInput.blur();
      }
    }

    performSearch() {
      const query = this.searchInput.value.trim();
      if (query) {
        // Effectuer une recherche complète
        window.dispatchEvent(new CustomEvent('searchPerformed', {
          detail: { query, filter: this.currentFilter }
        }));
      }
    }

    setSearchFilter(filter) {
      this.currentFilter = filter;

      // Mettre à jour l'interface
      document.querySelectorAll('.search-filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
          btn.classList.remove('bg-mv-cream', 'text-mv-forest');
          btn.classList.add('bg-mv-leaf', 'text-mv-cream');
        } else {
          btn.classList.remove('bg-mv-leaf', 'text-mv-cream');
          btn.classList.add('bg-mv-cream', 'text-mv-forest');
        }
      });

      // Relancer la recherche si nécessaire
      const query = this.searchInput.value.trim();
      if (query.length >= 2) {
        this.search(query);
      }
    }
  }

  // Initialiser quand le DOM est prêt
  document.addEventListener('DOMContentLoaded', () => {
    window.advancedSearch = new AdvancedSearch();
  });

  // Exposer la classe globalement
  window.AdvancedSearch = AdvancedSearch;
</script>

<style>
  .advanced-search {
    position: relative;
  }

  .search-input-container {
    position: relative;
  }

  .search-suggestions {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
  }

  .suggestion-item {
    transition: background-color 0.15s ease;
  }

  .suggestion-item:hover {
    background-color: #f9fafb;
  }

  mark {
    background-color: rgba(34, 197, 94, 0.2);
    padding: 0 2px;
    border-radius: 2px;
  }

  /* Animation d'entrée des suggestions */
  .search-suggestions {
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 640px) {
    .search-filters {
      justify-content: center;
    }

    .search-filter-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>