---
// ShoppingList.astro - Composant pour gérer les listes de courses
---

<div id="shopping-list" class="fixed top-20 right-4 sm:right-6 z-[55] pointer-events-auto" style="position: fixed; top: 5rem; right: 1rem; left: auto;">
  <!-- Bouton flottant -->
  <button
    id="shopping-list-toggle"
    class="bg-mv-forest text-mv-cream p-3 rounded-full shadow-lg hover:bg-mv-leaf transition-all duration-300 hover:scale-110"
    aria-label="Ouvrir la liste de courses"
  >
    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
    </svg>
    <span id="shopping-count" class="absolute -top-2 -right-2 bg-mv-coral text-mv-cream text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
  </button>

  <!-- Panneau de la liste de courses -->
  <div id="shopping-panel" class="hidden absolute top-16 right-0 bg-white rounded-lg shadow-xl border border-mv-leaf-20 w-80 max-h-96 overflow-hidden">
    <div class="p-4 border-b border-mv-leaf-20">
      <h3 class="font-serif font-bold text-mv-forest text-lg">Ma liste de courses</h3>
      <p class="text-sm text-mv-forest-70 mt-1">Ingrédients pour vos recettes</p>
    </div>

    <div id="shopping-items" class="max-h-64 overflow-y-auto p-4 space-y-2">
      <!-- Les éléments seront ajoutés dynamiquement -->
      <div class="text-center text-mv-forest-60 py-8">
        <svg class="h-12 w-12 mx-auto mb-3 text-mv-leaf-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <p class="text-sm">Votre liste est vide</p>
        <p class="text-xs text-mv-forest-50 mt-1">Ajoutez des ingrédients depuis les recettes</p>
      </div>
    </div>

    <div class="p-4 border-t border-mv-leaf-20 bg-mv-cream">
      <div class="flex space-x-2">
        <button
          id="clear-shopping-list"
          class="mv-btn mv-btn-secondary flex-1 bg-mv-cream text-mv-forest text-sm hover:bg-mv-leaf-10 transition-colors disabled:opacity-50"
          disabled
        >
          Vider
        </button>
        <button
          id="export-shopping-list"
          class="mv-btn mv-btn-primary flex-1 bg-mv-forest text-mv-cream text-sm hover:bg-mv-leaf transition-colors disabled:opacity-50"
          disabled
        >
          Exporter
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { confirmDialog } from '../lib/confirm.js';
  import { showToast } from '../lib/notify.js';

  class ShoppingListManager {
    constructor() {
      this.items = new Map();
      this.loadFromStorage();
      this.init();
    }

    init() {
      // Éléments DOM
      this.toggleBtn = document.getElementById('shopping-list-toggle');
      this.panel = document.getElementById('shopping-panel');
      this.itemsContainer = document.getElementById('shopping-items');
      this.countBadge = document.getElementById('shopping-count');
      this.clearBtn = document.getElementById('clear-shopping-list');
      this.exportBtn = document.getElementById('export-shopping-list');

      // Événements
      this.toggleBtn.addEventListener('click', () => this.togglePanel());
      this.clearBtn.addEventListener('click', () => this.clearList());
      this.exportBtn.addEventListener('click', () => this.exportList());

      // Ajout depuis les cartes/recettes
      window.addEventListener('addToShoppingList', (event) => {
        const detail = event.detail || {};
        if (detail.ingredients && Array.isArray(detail.ingredients)) {
          this.addIngredients(detail.ingredients, { sourceTitle: detail.recipeTitle });
          return;
        }

        if (detail.recipeId) {
          const recipe = this.findRecipe(detail.recipeId);
          if (recipe && Array.isArray(recipe.ingredients)) {
            this.addIngredients(recipe.ingredients, { sourceTitle: recipe.title || detail.recipeTitle });
          }
        }
      });

      // Fermer en cliquant ailleurs
      document.addEventListener('click', (e) => {
        if (!this.panel.contains(e.target) && !this.toggleBtn.contains(e.target)) {
          this.closePanel();
        }
      });

      // Raccourci clavier
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.closePanel();
        }
      });

      this.updateUI();
    }

    findRecipe(recipeId) {
      let index = window.recipeIndex || window.__recipesIndex || null;
      if (!index) {
        const dataEl = document.getElementById('recipes-index');
        if (dataEl?.textContent) {
          try {
            index = JSON.parse(dataEl.textContent);
            window.recipeIndex = index;
          } catch (error) {
            console.error("Impossible de lire l'index des recettes", error);
          }
        }
      }
      if (Array.isArray(index)) {
        return index.find((recipe) => recipe.id === recipeId);
      }
      if (index && typeof index === 'object') {
        return index[recipeId] || null;
      }
      return null;
    }

    togglePanel() {
      if (this.panel.classList.contains('hidden')) {
        this.openPanel();
      } else {
        this.closePanel();
      }
    }

    openPanel() {
      this.panel.classList.remove('hidden');
      this.panel.classList.add('animate-in', 'slide-in-from-right-2');
    }

    closePanel() {
      this.panel.classList.add('hidden');
      this.panel.classList.remove('animate-in', 'slide-in-from-right-2');
    }

    normalizeName(value) {
      return (value || '').toString().toLowerCase().trim();
    }

    parseQuantity(value) {
      if (value === null || value === undefined) return null;
      if (typeof value === 'number' && Number.isFinite(value)) return value;

      const raw = value.toString().trim().replace(',', '.');
      if (!raw) return null;

      const mixedFractionMatch = raw.match(/^(\d+)\s+(\d+)\/(\d+)$/);
      if (mixedFractionMatch) {
        const whole = Number(mixedFractionMatch[1]);
        const num = Number(mixedFractionMatch[2]);
        const den = Number(mixedFractionMatch[3]);
        if (den) return whole + num / den;
      }

      const fractionMatch = raw.match(/^(\d+)\/(\d+)$/);
      if (fractionMatch) {
        const num = Number(fractionMatch[1]);
        const den = Number(fractionMatch[2]);
        if (den) return num / den;
      }

      const numeric = Number(raw);
      if (!Number.isNaN(numeric)) return numeric;

      return null;
    }

    formatQuantity(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return '';
      const rounded = Math.round(value * 100) / 100;
      const str = rounded.toString();
      return str.replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
    }

    buildKey(name, unit, quantity, numericQuantity) {
      const normalizedName = this.normalizeName(name);
      const normalizedUnit = this.normalizeName(unit);
      if (numericQuantity !== null) {
        return `${normalizedName}|${normalizedUnit}`;
      }
      const quantityPart = (quantity || '').toString().trim();
      return `${normalizedName}|${normalizedUnit}|${quantityPart}`;
    }

    addItem(name, quantity = '', unit = '', options = {}) {
      const normalizedName = this.normalizeName(name);
      if (!normalizedName) return;

      const quantityValue = this.parseQuantity(quantity);
      const key = this.buildKey(name, unit, quantity, quantityValue);
      const existing = this.items.get(key);

      if (existing && quantityValue !== null && existing.numericQuantity !== null) {
        existing.numericQuantity += quantityValue;
        existing.quantity = this.formatQuantity(existing.numericQuantity);
      } else if (!existing) {
        this.items.set(key, {
          key,
          name,
          quantity: quantityValue !== null ? this.formatQuantity(quantityValue) : (quantity || '').toString().trim(),
          unit: unit || '',
          checked: false,
          numericQuantity: quantityValue
        });
      }

      if (!options.skipSave) {
        this.saveToStorage();
      }
      if (!options.skipUpdate) {
        this.updateUI();
      }

      if (!options.silent) {
        this.showFeedback(`"${name}" ajouté à la liste`);
      }
    }

    addIngredients(ingredients, options = {}) {
      if (!Array.isArray(ingredients) || ingredients.length === 0) {
        return;
      }

      ingredients.forEach((ingredient) => {
        if (!ingredient || !ingredient.name) return;
        this.addItem(
          ingredient.name,
          ingredient.quantity || '',
          ingredient.unit || '',
          { silent: true, skipSave: true, skipUpdate: true }
        );
      });

      this.saveToStorage();
      this.updateUI();

      if (!options.silent) {
        const label = options.sourceTitle ? ` (${options.sourceTitle})` : '';
        this.showFeedback(`${ingredients.length} ingrédient${ingredients.length > 1 ? 's' : ''} ajouté${ingredients.length > 1 ? 's' : ''}${label}`);
      }
    }

    removeItem(itemKey) {
      this.items.delete(itemKey);
      this.saveToStorage();
      this.updateUI();
    }

    toggleItem(itemKey) {
      const item = this.items.get(itemKey);
      if (item) {
        item.checked = !item.checked;
        this.saveToStorage();
        this.updateUI();
      }
    }

    async clearList() {
      const ok = await confirmDialog('Êtes-vous sûr de vouloir vider la liste de courses ?');
      if (!ok) return;
      this.items.clear();
      this.saveToStorage();
      this.updateUI();
      showToast('La liste de courses a été vidée', { type: 'info' });
    }

    exportList() {
      const items = Array.from(this.items.values());
      const text = items.map(item => {
        const quantityText = item.quantity ? `${item.quantity}${item.unit ? ` ${item.unit}` : ''}` : (item.unit || '');
        const line = quantityText ? `${quantityText} ${item.name}` : item.name;
        return `${item.checked ? '✓' : '○'} ${line}`;
      }).join('\n');

      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'liste-courses.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    updateUI() {
      const items = Array.from(this.items.values());
      const totalItems = items.length;

      // Mettre à jour le badge
      this.countBadge.textContent = totalItems.toString();
      this.countBadge.classList.toggle('hidden', totalItems === 0);

      // Mettre à jour les boutons
      this.clearBtn.disabled = totalItems === 0;
      this.exportBtn.disabled = totalItems === 0;

      // Mettre à jour la liste
      if (totalItems === 0) {
        this.itemsContainer.innerHTML = `
          <div class="text-center text-mv-forest-60 py-8">
            <svg class="h-12 w-12 mx-auto mb-3 text-mv-leaf-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p class="text-sm">Votre liste est vide</p>
            <p class="text-xs text-mv-forest-50 mt-1">Ajoutez des ingrédients depuis les recettes</p>
          </div>
        `;
      } else {
        this.itemsContainer.innerHTML = '';
        const fragment = document.createDocumentFragment();

        items.forEach((item) => {
          const quantityText = item.quantity ? `${item.quantity}${item.unit ? ` ${item.unit}` : ''}` : (item.unit || '');
          const row = document.createElement('div');
          row.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-mv-cream-50 transition-colors';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'shopping-item-checkbox h-4 w-4 text-mv-forest focus:ring-mv-leaf border-mv-leaf-30 rounded';
          checkbox.dataset.itemKey = item.key;
          if (item.checked) checkbox.checked = true;

          const label = document.createElement('span');
          label.className = `flex-1 text-sm ${item.checked ? 'line-through text-mv-forest-60' : 'text-mv-forest'}`;
          label.textContent = `${quantityText ? `${quantityText} ` : ''}${item.name}`;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'shopping-item-remove text-mv-coral hover:text-mv-coral-80 p-1 rounded transition-colors';
          removeBtn.dataset.itemKey = item.key;
          removeBtn.setAttribute('aria-label', `Retirer ${item.name}`);

          const icon = document.createElement('svg');
          icon.className = 'h-4 w-4';
          icon.setAttribute('fill', 'none');
          icon.setAttribute('stroke', 'currentColor');
          icon.setAttribute('viewBox', '0 0 24 24');
          icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
          removeBtn.appendChild(icon);

          row.appendChild(checkbox);
          row.appendChild(label);
          row.appendChild(removeBtn);
          fragment.appendChild(row);
        });

        this.itemsContainer.appendChild(fragment);

        // Attacher les événements aux nouveaux éléments
        this.attachItemEvents();
      }
    }

    attachItemEvents() {
      // Événements pour les checkboxes
      this.itemsContainer.querySelectorAll('.shopping-item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          this.toggleItem(e.target.dataset.itemKey);
        });
      });

      // Événements pour les boutons de suppression
      this.itemsContainer.querySelectorAll('.shopping-item-remove').forEach(button => {
        button.addEventListener('click', (e) => {
          const key = e.currentTarget?.dataset?.itemKey;
          if (key) this.removeItem(key);
        });
      });
    }

    showFeedback(message) {
      // Créer une notification temporaire (accessible)
      const notification = document.createElement('div');
      notification.className = 'fixed top-20 right-4 bg-mv-forest text-mv-cream px-4 py-2 rounded-lg shadow-lg z-50 animate-in slide-in-from-right-2';
      notification.setAttribute('role', 'status');
      notification.setAttribute('aria-live', 'polite');
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('animate-out', 'slide-out-to-right-2');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 2000);
    }

    saveToStorage() {
      try {
        const data = Array.from(this.items.entries());
        localStorage.setItem('gastronomade-shopping-list', JSON.stringify(data));
      } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
      }
    }

    loadFromStorage() {
      try {
        const data = localStorage.getItem('gastronomade-shopping-list');
        if (data) {
          const parsed = JSON.parse(data);
          this.items = new Map(parsed);
          this.items.forEach((item, key) => {
            item.key = item.key || key;
            if (item.numericQuantity === undefined) {
              item.numericQuantity = this.parseQuantity(item.quantity);
            }
          });
        }
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
        this.items = new Map();
      }
    }

    // Méthode publique pour ajouter des ingrédients depuis les recettes
    static addIngredients(ingredients, options = {}) {
      if (!window.shoppingListManager) {
        window.shoppingListManager = new ShoppingListManager();
      }
      window.shoppingListManager.addIngredients(ingredients, options);
    }
  }

  // Initialiser quand le DOM est prêt
  document.addEventListener('DOMContentLoaded', () => {
    window.shoppingListManager = new ShoppingListManager();
  });

  // Exposer la classe globalement pour utilisation dans les recettes
  window.ShoppingListManager = ShoppingListManager;
</script>
