---
// SpacingOptimizer.astro - Optimisation des espacements et proportions
export interface Props {
  enableResponsiveSpacing?: boolean;
  enableDynamicSpacing?: boolean;
  baseSpacingUnit?: number;
}

const {
  enableResponsiveSpacing = true,
  enableDynamicSpacing = true,
  baseSpacingUnit = 4
} = Astro.props;
---

<div class="spacing-optimizer">
  <!-- Variables CSS pour l'espacement responsive -->
  <style>
    :root {
      /* Unités de base d'espacement */
      --spacing-xs: calc(var(--base-unit) * 0.5);   /* 2px */
      --spacing-sm: var(--base-unit);               /* 4px */
      --spacing-md: calc(var(--base-unit) * 2);     /* 8px */
      --spacing-lg: calc(var(--base-unit) * 3);     /* 12px */
      --spacing-xl: calc(var(--base-unit) * 4);     /* 16px */
      --spacing-2xl: calc(var(--base-unit) * 6);    /* 24px */
      --spacing-3xl: calc(var(--base-unit) * 8);    /* 32px */
      --spacing-4xl: calc(var(--base-unit) * 12);   /* 48px */
      --spacing-5xl: calc(var(--base-unit) * 16);   /* 64px */

      /* Variables dynamiques */
      --container-padding: var(--spacing-xl);
      --section-spacing: var(--spacing-4xl);
      --card-spacing: var(--spacing-lg);
      --text-spacing: var(--spacing-sm);
    }

    /* Espacement responsive */
    .spacing-responsive {
      padding: var(--container-padding);
      margin-bottom: var(--section-spacing);
    }

    .spacing-card {
      padding: var(--card-spacing);
      margin-bottom: var(--card-spacing);
    }

    .spacing-text {
      margin-bottom: var(--text-spacing);
    }

    /* Breakpoints pour l'espacement */
    @media (max-width: 640px) {
      :root {
        --container-padding: var(--spacing-lg);
        --section-spacing: var(--spacing-3xl);
        --card-spacing: var(--spacing-md);
        --text-spacing: var(--spacing-xs);
      }
    }

    @media (max-width: 480px) {
      :root {
        --container-padding: var(--spacing-md);
        --section-spacing: var(--spacing-2xl);
        --card-spacing: var(--spacing-sm);
      }
    }

    /* Utilitaires d'espacement */
    .space-y-responsive > * + * {
      margin-top: var(--card-spacing);
    }

    .space-x-responsive > * + * {
      margin-left: var(--card-spacing);
    }

    .gap-responsive {
      gap: var(--card-spacing);
    }

    /* Proportions de grille responsive */
    .grid-responsive-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--card-spacing);
    }

    .grid-responsive-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--card-spacing);
    }

    .grid-responsive-3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--card-spacing);
    }

    .grid-responsive-4 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--card-spacing);
    }

    @media (min-width: 640px) {
      .grid-responsive-2 {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid-responsive-3 {
        grid-template-columns: repeat(3, 1fr);
      }

      .grid-responsive-4 {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .grid-responsive-3 {
        grid-template-columns: repeat(3, 1fr);
      }

      .grid-responsive-4 {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Conteneurs avec espacement optimisé */
    .container-optimized {
      max-width: 1200px;
      margin: 0 auto;
      padding-left: var(--container-padding);
      padding-right: var(--container-padding);
    }

    .section-optimized {
      padding-top: var(--section-spacing);
      padding-bottom: var(--section-spacing);
    }

    /* Cartes avec proportions optimisées */
    .card-optimized {
      border-radius: calc(var(--base-unit) * 2);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s ease;
    }

    .card-optimized:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Typographie avec espacement optimisé */
    .text-optimized h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      line-height: 1.2;
      margin-bottom: var(--text-spacing);
    }

    .text-optimized h2 {
      font-size: clamp(1.5rem, 4vw, 2.25rem);
      line-height: 1.3;
      margin-bottom: var(--text-spacing);
    }

    .text-optimized h3 {
      font-size: clamp(1.25rem, 3vw, 1.875rem);
      line-height: 1.4;
      margin-bottom: var(--text-spacing);
    }

    .text-optimized p {
      margin-bottom: var(--text-spacing);
      line-height: 1.6;
    }

    .text-optimized .lead {
      font-size: clamp(1.125rem, 2.5vw, 1.25rem);
      line-height: 1.6;
      margin-bottom: calc(var(--text-spacing) * 2);
    }

    /* Boutons avec proportions optimisées */
    .btn-optimized {
      padding: calc(var(--base-unit) * 2) calc(var(--base-unit) * 4);
      border-radius: calc(var(--base-unit) * 1.5);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px; /* Accessibilité mobile */
    }

    .btn-optimized:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Formulaires avec espacement optimisé */
    .form-optimized .form-group {
      margin-bottom: var(--card-spacing);
    }

    .form-optimized label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
      color: #374151;
    }

    .form-optimized input,
    .form-optimized textarea,
    .form-optimized select {
      width: 100%;
      padding: calc(var(--base-unit) * 2);
      border: 1px solid #d1d5db;
      border-radius: calc(var(--base-unit) * 1.5);
      font-size: 0.875rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-optimized input:focus,
    .form-optimized textarea:focus,
    .form-optimized select:focus {
      outline: none;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    /* Navigation avec espacement optimisé */
    .nav-optimized {
      padding: var(--container-padding) 0;
    }

    .nav-optimized .nav-list {
      display: flex;
      gap: var(--spacing-xl);
      align-items: center;
    }

    .nav-optimized .nav-item {
      position: relative;
    }

    .nav-optimized .nav-link {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: calc(var(--base-unit) * 1.5);
      transition: background-color 0.2s ease;
      text-decoration: none;
      color: inherit;
    }

    .nav-optimized .nav-link:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    /* Pied de page avec espacement optimisé */
    .footer-optimized {
      padding: var(--section-spacing) var(--container-padding);
      border-top: 1px solid #e5e7eb;
    }

    .footer-optimized .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-2xl);
    }

    /* Animations d'espacement */
    .spacing-animated {
      transition: margin 0.3s ease, padding 0.3s ease;
    }

    /* Accessibilité */
    @media (prefers-reduced-motion: reduce) {
      .card-optimized,
      .btn-optimized,
      .form-optimized input,
      .form-optimized textarea,
      .form-optimized select,
      .nav-optimized .nav-link,
      .spacing-animated {
        transition: none;
      }
    }

    /* Mode sombre */
    @media (prefers-color-scheme: dark) {
      .card-optimized {
        background-color: #1f2937;
        border-color: #374151;
      }

      .form-optimized label {
        color: #e5e7eb;
      }

      .form-optimized input,
      .form-optimized textarea,
      .form-optimized select {
        background-color: #1f2937;
        border-color: #374151;
        color: #e5e7eb;
      }

      .nav-optimized .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .footer-optimized {
        border-color: #374151;
      }
    }
  </style>
</div>

<script>
  class SpacingOptimizer {
    constructor(options = {}) {
      this.options = {
        enableResponsiveSpacing: true,
        enableDynamicSpacing: true,
        baseSpacingUnit: 4,
        ...options
      };

      this.init();
    }

    init() {
      if (this.options.enableResponsiveSpacing) {
        this.initResponsiveSpacing();
      }

      if (this.options.enableDynamicSpacing) {
        this.initDynamicSpacing();
      }

      this.updateSpacingVariables();
      this.bindResizeListener();
    }

    initResponsiveSpacing() {
      // Appliquer les classes d'espacement responsive
      this.applyResponsiveClasses();
    }

    initDynamicSpacing() {
      // Observer les changements de contenu pour ajuster l'espacement
      this.observeContentChanges();
    }

    updateSpacingVariables() {
      const root = document.documentElement;
      const viewportWidth = window.innerWidth;

      // Ajuster l'unité de base selon la taille d'écran
      let baseUnit = this.options.baseSpacingUnit;

      if (viewportWidth < 480) {
        baseUnit = Math.max(3, baseUnit * 0.75);
      } else if (viewportWidth < 768) {
        baseUnit = Math.max(3.5, baseUnit * 0.875);
      }

      root.style.setProperty('--base-unit', `${baseUnit}px`);

      // Ajuster les autres variables en conséquence
      this.updateDerivedVariables(baseUnit);
    }

    updateDerivedVariables(baseUnit) {
      const root = document.documentElement;

      root.style.setProperty('--container-padding', `${baseUnit * 4}px`);
      root.style.setProperty('--section-spacing', `${baseUnit * 12}px`);
      root.style.setProperty('--card-spacing', `${baseUnit * 3}px`);
      root.style.setProperty('--text-spacing', `${baseUnit}px`);
    }

    applyResponsiveClasses() {
      // Appliquer automatiquement les classes d'espacement aux éléments appropriés
      const containers = document.querySelectorAll('.container:not(.container-optimized)');
      containers.forEach(container => {
        container.classList.add('container-optimized');
      });

      const sections = document.querySelectorAll('section:not(.section-optimized)');
      sections.forEach(section => {
        section.classList.add('section-optimized');
      });

      const cards = document.querySelectorAll('.card:not(.card-optimized)');
      cards.forEach(card => {
        card.classList.add('card-optimized');
      });

      const forms = document.querySelectorAll('form:not(.form-optimized)');
      forms.forEach(form => {
        form.classList.add('form-optimized');
      });
    }

    observeContentChanges() {
      // Observer les changements de contenu pour ajuster l'espacement dynamique
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            this.adjustSpacingForNewContent(mutation.target);
          }
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    adjustSpacingForNewContent(container) {
      // Ajuster l'espacement pour le nouveau contenu
      const newElements = container.querySelectorAll(':not([data-spacing-adjusted])');

      newElements.forEach(element => {
        // Ajouter des classes d'espacement selon le type d'élément
        if (element.tagName === 'P' || element.tagName === 'DIV') {
          element.classList.add('spacing-text');
        }

        element.setAttribute('data-spacing-adjusted', 'true');
      });
    }

    bindResizeListener() {
      let resizeTimeout;

      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          this.updateSpacingVariables();
        }, 100);
      });
    }

    // Méthodes utilitaires
    static applyOptimizedSpacing(element) {
      element.classList.add('spacing-responsive', 'spacing-animated');
    }

    static createResponsiveGrid(columns = 3) {
      const grid = document.createElement('div');
      grid.className = `grid-responsive-${columns}`;
      return grid;
    }

    static optimizeTypography(element) {
      element.classList.add('text-optimized');
    }

    static optimizeForm(element) {
      element.classList.add('form-optimized');
    }

    static optimizeNavigation(element) {
      element.classList.add('nav-optimized');
    }

    static optimizeFooter(element) {
      element.classList.add('footer-optimized');
    }
  }

  // Initialiser l'optimisation d'espacement
  document.addEventListener('DOMContentLoaded', () => {
    window.spacingOptimizer = new SpacingOptimizer({
      enableResponsiveSpacing: true,
      enableDynamicSpacing: true,
      baseSpacingUnit: 4
    });
  });

  // Exposer la classe globalement
  window.SpacingOptimizer = SpacingOptimizer;
</script>